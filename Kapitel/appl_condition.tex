\section{general application conditions}

To guarantee that each transformation $t: G \Longrightarrow_{\rho,m} H$, given a rule $\rho = L \xhookleftarrow{} K \xhookrightarrow{} R$  , is (direct) consistency increasing w.r.t to a constraint $c$, we present applications conditions ensuring this property. 
It has to be ensured that at least one violation will be removed. 
For this, it is necessary (a) to check that an occurrence $p$ of the the universally bound graph $C_{\maxc{G} +1}$ exists, such that $p$ and the match $m$ do overlap, i.e $p(C_{\maxc{G} + 1}) \cap m(L) \neq \emptyset$, and (b) that $p$ does not satisfy $c' = \exists C_{\maxc{G} + 2}$. 
Only in this case, it is possible that the transformation does remove a violation. 
To ensure that $p$ does not satisfy $c'$, the non-existence of all possible overlaps of $L$ and $C_{\maxc{G} + 2}$ such that $p \models c'$ has to be checked. 
For this, we introduce \emph{extended overlaps}.
Intuitively, given an overlap $C$ of $L$ and $C_{\maxc{G} + 1}$ with $p: C_{\maxc{G} + 1} \inj C$, the set of extended overlaps contains all overlaps $C'$ of $L$ and $C_{\maxc{G} + 2}$, such that $p \models c'$ if one of these overlaps exists.


\begin{definition}[\textbf{extended overlaps}]
Let $G$, $C_0$ and $C_1$ with $i:C_0 \inj C_1$ be graphs. 
Let $C$ be an overlap of $C_0$ and $G$ with the inclusion $q : C_0 \inj C$. 
The set of \emph{extended overlaps of $C$ with $i$}, $\eol(C,i)$, is the set of all overlaps $C'$ of $G$ and $C_1$, such that an injective morphism $i_C: C \inj C'$ with $i_C \circ q \models \exists(i: C_0 \inj C_1, \true)$ exists. 
\end{definition}


%
%\begin{definition}[\textbf{overlap shift}]
%Let $\rho = L \xhookleftarrow{} K \xhookrightarrow{} R$ be a plain rule, $C$ a graph and $C'$ an overlap of $C$ and $L$ with morphisms $p : L \inj C'$, $k: K \inj C'$, $c:C \inj C'$ and the partial morphism $q: R \inj C'$. 
%We define 
%\begin{equation}
%\begin{split}
%	D := \{e \in C' \mid &(\exists e' \in L: p(e') = e \\ &\vee \exists e' \in R: q(e') = e) \\ &\wedge \exists e' \in C: c(e') = e \}
%\end{split}
%\end{equation}
%Let $r = L \xhookleftarrow{} K' \xhookrightarrow{} R$ be the rule with 
%$$K' := K \cup D$$
%The graph $H$ derived by the transformation $G \Rightarrow_{r,p} H$ is called the \emph{overlap shifted graph of $C'$ with $C$ and  $\rho$}.
%The overlap shifted graph of an graph $C$ is denoted by $\ols_{\rho}(C,C')$.
%\end{definition} 


A direct consistency increasing application condition has to, as mentioned above, (a) ensure that at least one violation will be removed, (b) ensure that no new violations get inserted and (c) secure that the partial consistency is not decreased. 
In the definition below, $\nex()$ and $\rep()$ ensure that (a) is met, with $\nex()$ ensuring that a violation is present and $\rep()$ ensuring that this violation will be removed. Note, that the construction of these is divided in two cases. 
Firstly, either $k < \nl(c)-1$ or the constraints ends with a condition of the form $\exists(a: C \inj C', \true)$ and secondly, $k = \nl(c)-1$ and the constraint ends with a condition of the form $\forall(a: C_0 \inj C_1, \false)$.

For $\nex()$, the first case will be checked as already described above. 
In the second case, it is sufficient to check whether an occurrence $p$ of $C_k$ with $m(L) \cap p(C_k) \neq \emptyset$ exists.

For $\rep()$, in the first case, a violation can be removed by either deleting an occurrence $p$ of $C_k$ or inserting elements of $C_{k+1}$, such that $p \not \models \exists C'$ and $\track_t \circ p \models \exists C'$ for a graph $C' \in \mathcal{U}(C_k, C_{k+1})$.
In the second case, a violation can only be removed by deleting an occurrence $p$ of $C_1$. 
This will only occur if $m(L \setminus K) \cap p(C_1) \neq \emptyset$. 

The conditions constructed by $\nin()$ and $\nwo()$ ensure that (2) is me, with $\nin()$ checking that no new occurrence of $C_k$ will be inserted and $\nwo()$ ensuring that for an occurrence $p$ of $C_k$ if $p \models \exists C'$ it is secured that $\track_t \circ p \models \exists C'$ for any $C' \in \mathcal{U}(C_k, C_{k+1})$. 

Additionally, the conditions constructed by $\rem()$ and $\nin()$ ensure (3), with $\rem()$ ensuring that no occurrence of existentially bound graphs $C_j$ with $j \leq k$ will be deleted and $\nin()$ ensuring that no occurrences of universally bound graphs $C_j$ with $j \leq k$ will be inserted. 
With this, it is guaranteed that the partial consistency will not be decreased. 





\begin{definition}[\textbf{general application condition}]\label{def_appl_cond}
Let $\rho = L \xhookleftarrow{} K \xhookrightarrow{} R$ be a plain rule and $c$ a constraint in EANF. 
Let $d = \forall(a_k: C_{k-1} \inj C_{k},e)$ be the subcondition of $c$ at layer $k$ with $k$ being an odd number.

The application condition $\ap_k$ of $c$ at layer $k$ with 
$C' = C_k$, if $e = \false$, and $C' \in \mathcal{U}(C_k, C_{k+1})$ otherwise is defined as:
\begin{equation}
\ap(k,C') := \big(\bigvee_{P \in \overlay(L,C_k)} \nex(P,C') \wedge \rep(P,C')\big) \wedge \nin \wedge \rem \wedge \nwo
\end{equation}

with
\begin{enumerate}
\item Let $a^p: C' \inj C_{k+1}$ be a partial morphism of $a_{k+1}$.
	$$\nex(P,C') := 
			\begin{cases}
			\exists (i_L: L \inj P, \true) &\textit{if } e = \false \\
			\bigwedge_{Q \in \eol(P,a^p)} \exists(i_L: L \inj P, \neg \exists(i_P: P \inj Q, \true)) &\textit{otherwise}
			\end{cases}			
			$$
			
	
\item Let $\mathbf{P}$ be the set of all overlaps of $R$ and $C'$, such that $i_R(R\setminus K) \cap i_{C'}(C') \neq \emptyset$:
\begin{enumerate}
	\item If $e = \false$: 
		$$ \rep(P,C') := \begin{cases}
							\true &\textit{, if } i_L(L \setminus K) \cap i_{C_k} (C_k) \neq \emptyset\\
							\false &\textit{, otherwise}
						  \end{cases}$$
\item Otherwise:
	$$ \rep(P,C') := \begin{cases}
						\true &\textit{, if } i_L(L \setminus K) \cap i_{C_k}(C_k) \neq \emptyset \\
						\bigvee_{P' \in \mathbf{P}} \shift(\exists(i_R: R \inj P', \true), \rho) &\textit{, otherwise}
					 \end{cases}$$
\end{enumerate}					 
\item Let $E$ be the set of all graphs $C_j$ of $c$ with $j \leq k$ and $j$ being odd and let $\mathbf{P}_{C_j}$ be the set all overlaps of $L$ and $C_j$ with $i_L(L \setminus K) \cap i_{C_j}(C_j) \neq \emptyset$. 
$$\rem := \bigwedge_{C \in E} \bigwedge_{C' \in  \mathbf{P}_{C_j}} \neg \exists(i_L: L \inj C', \true)$$

\item Let $U$ be the set of all graphs $C_j$ of $c$ with $j \leq k$ and $j$ being even and let $\mathbf{P_{C_j}} $ be the set of all overlaps of $R$ and $C_j$ with $i_R(R \setminus K) \cap i_{C_j}(C_j) \neq \emptyset$.
$$\nin := \bigwedge_{C \in U} \bigwedge_{C' \in \mathbf{P}_{C_j}} \shift(\neg \exists(i_R: R \inj C', \true), \rho)$$

\item Let $E$ be the set of all overlaps of $L$ and $C_k$, such that each $P \in E$ is also an overlap of $L$ and $C'' \in \mathcal{U}(C_k, C_{k+1})$, $i_{C_k} \models \exists(a'_k: C_k \inj C'', \true)$ and  $i_L(L\setminus K) \cap i_{C''}(C'' \setminus C_k) \neq \emptyset$.
$$\nwo := \bigwedge_{P \in E} \neg \exists(i_L: L \inj P, \true) $$
\end{enumerate}
\end{definition}





\begin{lemma}
Let a graph $G$, a constraint $c$ in EANF, with $G \not \models c$, and a plain rule $\rho$ be given. 
Then, the rule $\rho'(\rho, \ap(\maxc{G},C))$ for a graph $C \in \mathcal{U}(C_{\maxc{G}}, C_{\maxc{G}+1})$ is a minimal consistency improving rule.  

\end{lemma}
\begin{proof}
Let $t: G \Longrightarrow_{\rho', m} H$ be a transformation and $k = \maxc{G}+1$. 
We show, by contradiction, that this transformation is direct minimal consistency improving by showing that (\ref{direct_improving_1}), (\ref{direct_improving_1_2}), (\ref{direct_improving_2}), (\ref{direct_improving_3}) and (\ref{direct_improving_4}) are satisfied. 
With that, it follows that $\rho'$ is a minimal consistency improving rule. 
Let $d = \forall(a_k: C_k \inj C_{k+1},e)$ be the subcondition of $c$ at layer $k$. 

\begin{enumerate}
\item Assume that (\ref{direct_improving_1}) does not hold. 
Then, there does exist an morphism $p: C_k \inj G$, such that $p \models \parcond(1,e,C')$, $\track_t \circ p$ is total and $\track_t \circ p \not \models \parcond(1,e,C')$ for a graph $C' \in \mathcal{U}(C_k, C_{k+1})$. 
There has to exist an overlap $P$ of $L$ and $C'$ such that $i_{C_k} \models \exists(a^p_k: C_k \inj C', \true)$ and $m \models \exists(i_L: L \inj P, \true)$. 
Then, $\nwo$ and with that $\ap(\maxc{G},C)$ is not satisfied. 

\item Assume that  (\ref{direct_improving_1_2}) does not hold. Then, a morphism $p': C_k \inj H$ with $p' \not \models \parcond(1,e,C_{k+1})$ exists, such that there does not exist a morphism $p :C_k \inj G$ with $\track_t \circ p = p'$. 
Then, an overlap $P$ of $R$ and $C_k$ with $i_R(R\setminus K) \cap i_R(C_k) \neq \emptyset$ exists, such that $m \models \shift(\exists(i_R: R \inj P, \true), \rho)$. 
Then, $m \not \models \ap(\maxc{G},C)$. 

\item Assume that (\ref{direct_improving_2}) does not hold. 
Then, there does not exist a morphism $p: C_k \inj G$ with $p \not \models \parcond(1,e,C)$, such that $\track_t \circ p$ is not total or $\track_t \circ p \models \parcond(1,e,C)$ and $\track_t \circ p$ is total.
Then, no overlap $P$ of $L$ and $C_k$ with $i_L(L\setminus K) \cap i_{C_k}(C_k) \neq \emptyset$ exists, such that $m \models \nex(P,C)$.
Also, no overlap $P$ of $C$ and $R$ with $i_R(R\setminus K) \cap i_{C}(C) \neq \emptyset$ and $m \models \nex(P,C)$ exists, such that $m \models \shift(\exists(i_R: R \inj P, \true), \rho)$ and therefore $\rep(P,C) = \false$. 
It follows that for all $P \in \overlay(L,C_k)$ it holds that $\nex(P,C) \wedge \rep(P,C) = \false$ and with that $m \not \models \ap(\maxc{G}, C)$.

\item Assume that (\ref{direct_improving_3}) does not hold.
Then, there does exist a morphism $p: C_j \inj G$ with $j < k$ and $i$ being even, such that no morphism $p': C_j \inj G$ with $\track_t \circ p' = p$ exists. 
Then, an overlap $P$ of $C_j$ and $R$ with $i_R(R \setminus K) \cap i_{C_j} \neq \emptyset$ exists, such that $m \models \shift(\exists(i_R: R \inj P, \true), \rho)$. 
It follows that $m \not \models \rem$ and with that $m \not \models \ap(\maxc{G}, C)$. 

\item Assume that (\ref{direct_improving_4}) does not hold.
Then, there does exist and morphism $p :C_j \inj G$ with $j < k$ and $j$ being odd, such that $\track_t \circ p$ is not total. 
Then, an overlap $P$ of $C_j$ and $L$ with $i_L(L \setminus K) \cap i_{C_j}(C_j) \neq \emptyset$ exists, such that $m \models \exists(i_L:L \inj P, \true)$. 
It follows that $m \not \models \rem$ and with that $m \not \models \ap(\maxc{G}, C)$.

\end{enumerate}
In total follows that if $m \models \ap(\maxc{G}, C)$, then $t$ is a direct minimal improving transformation. 
\end{proof}

\begin{lemma}
Let $G$ be a graph, $c$ a constraint in EANF, with $\maxc{G} < \nl(c)$,  and $\rho = L \xhookleftarrow{} K \xhookrightarrow{} R$ a plain rule.
Let $d = \forall(a_k : C_{k-1} \inj C_{k}, \exists(b: C_{k} \inj C_{k+1}, e))$ be the subcondition of $c$ at layer $\cmax + 1$ and $\ap(\cmax, C')$ the application condition constructed by definition \ref{def_appl_cond} with $C'\in \mathcal{U}(C, C_{k+1})$ for any $C \in \mathcal{G}_c^G$.
If 
$$((R \setminus K) \cap C_{k+1}) \cup ((L \setminus K) \cap C_{k+1}) = \emptyset$$
$\ap(\cmax, C')$ can be replaced by $\false$. 
\end{lemma}
\begin{proof}
There does not exist an overlap $P$ of $C_k$ and $L$ with $i_L(L \setminus K) \cap i_{C_k}(C_k) \neq \emptyset$ and $\rep(P,C')$ will be equal to $\false$, if $C_k = C_{k+1}$, or equal to $\bigvee_{P' \in \mathbf{P}} \shift(\exists(i_R: R \inj P', \true), \rho)$. 
Since the set $\mathbf{P}$ has to be empty, this expression can be replaced by $\false$. 
If follows that $\rep(P,C') = \false$ for all $P \in \overlay(L,C_k)$ and therefore $\ap(\cmax, C')$ will always be evaluated to $\false$.
\end{proof}

\input{Kapitel/pot_improving_rules}
