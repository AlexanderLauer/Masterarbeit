\section{application condition}



\begin{definition}[\textbf{extended overlaps}]
Let $G$ and $C_0 \subseteq C_1$ with the inclusion $i:C_0 \inj C_1$ be graphs. 
Let $C$ be an overlap of $C_0$ and $G$ with the inclusion $q : C_0 \inj C$. 
The set of \emph{extended overlaps of $C$ with $i$}, $\eol(C,i)$, is the set of all overlaps $C'$ of $G$ and $C_1$, such that $C \subseteq C'$ and $q \models \exists(i: C_0 \inj C_1, \true)$. 
\end{definition}



\begin{definition}[\textbf{overlap shift}]
Let $\rho = L \xhookleftarrow{} K \xhookrightarrow{} R$ be a plain rule, $C$ a graph and $C'$ an overlap of $C$ and $L$ with morphisms $p : L \inj C'$, $k: K \inj C'$, $c:C \inj C'$ and the partial morphism $q: R \inj C'$. 
We define 
\begin{equation}
\begin{split}
	D := \{e \in C' \mid &(\exists e' \in L: p(e') = e \\ &\vee \exists e' \in R: q(e') = e) \\ &\wedge \exists e' \in C: c(e') = e \}
\end{split}
\end{equation}
Let $r = L \xhookleftarrow{} K' \xhookrightarrow{} R$ be the rule with 
$$K' := K \cup D$$
The graph $H$ derived by the transformation $G \Rightarrow_{r,p} H$ is called the \emph{overlap shifted graph of $C'$ with $C$ and  $\rho$}.
The overlap shifted graph of an graph $C$ is denoted by $\ols_{\rho}(C,C')$.
\end{definition} 




\begin{definition}[\textbf{application condition}]
Let $\rho = L \xhookleftarrow{} K \xhookrightarrow{} R$ be a plain rule and $c$ a constraint in EANF. 
Let $d = \forall(a_k: C_{k-1} \inj C_{k},\exists(a_{k+1}: C_{k} \inj C_{k+1},e))$ be the subcondition of $c$ at layer $k$ with $k$ being and even number.

The application condition $\ap_k$ of $c$ at layer $k$ with $C' \in \mathcal{U}(C_k, C_{k+1})$ and $i:C_k \inj C'$ is defined as:
\begin{equation}
\ap(k,C') := \big(\bigvee_{P \in \overlay(L,C_k)} \nex(P,C') \wedge \rep(P,C')\big) \wedge \nin \wedge \rem
\end{equation}

with
\begin{enumerate}
\item 
	$$\nex(P,C') := 
			\begin{cases}
			\exists (i_L: L \inj P, \true) &\textit{, if } C_k = C_{k+1} \\
			\bigwedge_{Q \in \eol(P,i)} \exists(i_L: L \inj P, \neg \exists(i_P: P \inj Q, \true)) &\textit{, otherwise}
			\end{cases}			
			$$
			
	
\item Let $\mathbf{P}$ be the set of all overlaps of $R$ and $C'$, such that $i_R(R\setminus K) \cap i_{C'} \neq \emptyset$:
\begin{enumerate}
	\item If $C_k = C_{k+1}$: 
		$$ \rep(P,C') := \begin{cases}
							\true &\textit{, if } i_L(L \setminus K) \cap i_{C_k} (C_k) \neq \emptyset\\
							\false &\textit{, otherwise}
						  \end{cases}$$
\item Otherwise:
	$$ \rep(P,C') := \begin{cases}
						\true &\textit{, if } i_L(L \setminus K) \cap i_{C_k}(C_k) \neq \emptyset \\
						\bigvee_{P' \in \mathbf{P}} \shift(\exists(i_R: R \inj P', \true), \rho) &\textit{, otherwise}
					 \end{cases}$$
\end{enumerate}					 
\item Let $E$ be the set of all graphs $C_j$ of $c$ with $j \leq k$ and $j$ being even and let $\mathbf{P}_{C_j}$ be the set all overlaps of $L$ and $C_j$ with $i_L(L \setminus K) \cap i_{C_j}(C_j) \neq \emptyset$. 
$$\rem := \bigwedge_{C \in E} \bigwedge_{C' \in  \mathbf{P}_{C_j}} \neg \exists(i_L: L \inj C', \true)$$

\item Let $U$ be the set of all graphs $C_j$ of $c$ with $j \leq k$ and $j$ being odd and let $\mathbf{P_{C_j}} $ be the set of all overlaps of $R$ and $C_j$ with $i_R(R \setminus K) \cap i_{C_j}(C_j) \neq \emptyset$.
$$\nin := \bigwedge_{C \in U} \bigwedge_{C' \in \mathbf{P}_{C_j}} \shift(\neg \exists(i_R: R \inj C', \true), \rho)$$
\end{enumerate}
\end{definition}





\begin{lemma}
Let $G$ be a graph, $c$ a constraint in EANF, with $G \not \models c$, and $r$ a plain rule.
Let $d = \forall(a_k : C_{k-1} \inj C_{k}, \exists(b: C_{k} \inj C_{k+1}, e))$ be the subcondition of $c$ at layer $\cmax$. 
Then, every application of $(r,\ap(\cmax, C'))$ with $$C' \in \bigcap_{C \in \mathcal{G}_c^G} \mathcal{U}(C, C_{k+1})$$ is direct minimal consistency improving. 

\end{lemma}
\begin{proof}

\end{proof}

\begin{lemma}
Let $G$ be a graph, $c$ a constraint in EANF, with $\cmax < \nl(c)$,  and $r = L \xhookleftarrow{} K \xhookrightarrow{} R$ a plain rule.
Let $d = \forall(a_k : C_{k-1} \inj C_{k}, \exists(b: C_{k} \inj C_{k+1}, e))$ be the subcondition of $c$ at layer $\cmax + 1$ and $\ap(\cmax, C')$ the application condition constructed by definition \ref{general_app_cond} with $C'\in \mathcal{U}(C, C_{k+1})$ for any $C \in \mathcal{G}_c^G$.
The following simplifications can be applied:

\begin{enumerate}
	\item \label{simplification_appl_1}
	Let $P \in \overlay(L,C_{k})$. 
		  If an injective morphism $p : P \inj G$ does not exist, $\nex(P,C')$ can be replaced by $\false$.
	\item \label{simplification_appl_2}
	If $(L\setminus K) \cap C_{k} = \emptyset$, every $\del(P,C')$ can be replaced by $\false$ and $\ex(P,C')$ can be replaced by $\true$. 
	\item \label{simplification_appl_3}
	If $(R\setminus K) \cap C' = \emptyset$, every $\rep(P,C')$ can be replaced by $\false$.
	\item \label{simplification_appl_4}
	If \ref{simplification_appl_2}. and \ref{simplification_appl_3}. apply, $\ap(k,C')$ can be replaced by $\false$. 
	\item \label{simplification_appl_5}
	If $(R \setminus K) \cap C_{k+1} = \emptyset$, every $\rem(P,C')$ can be replaced by $\true$.
	
\end{enumerate}
\end{lemma}
\begin{proof}
Let $m: L \inj G$ be the match of the application of $r$. 
We show the simplifications by showing that the replaced parts of $\ap(\cmax,C')$ will be evaluated to the values they have been replaced with, if the required conditions are met. 
Note that $C_j \subseteq C_{k'}$ for all $0 \leq j \leq k'$ and $k' \in \{0, \ldots, \nl(c)\}$.  
\begin{itemize}
\item Proof of \ref{simplification_appl_1}.: Let $P \in \overlay(L,C_k)$ with $a: L \inj P$, such that no morphism $p: P \inj G$ exists. 
Therefore, no morphism $q: P \inj G$ with $m = p \circ a$ exists and $\nex(P,C')$ will be evaluated to $\false$. 

\item Proof of \ref{simplification_appl_2}.: Let $(L \setminus K) \cap C_k = \emptyset$ and $P \in \overlay(L,C_k)$ with $i': L \inj P$ and $i_j:C_j \inj P$ for all $j \leq k$.
If follows that $i'(L \setminus K) \cap i_k(C_k \setminus C_{k-1}) = \emptyset$ and with that $\del(P, C') = \false$ for every  $P \in \overlay(L,C_k)$.
Similar it follows that $$\bigcup_{j \leq k} i_j(C_j \setminus C_{j-1}) \cap i'(L \setminus K) = \emptyset$$ and with that $\ex(P,C') = \true$ for every  $P \in \overlay(L,C_k)$.

\item Proof of \ref{simplification_appl_3}.: work in progress. 

\item Proof of \ref{simplification_appl_4}.: Let the simplifications \ref{simplification_appl_2}. and \ref{simplification_appl_3}. apply. 
Every $\del(P,C')$ and every $\rep(P,C')$ have been replaced by $\false$. 
Therefore, the expression $$\bigvee_{P \in \overlay(L, C_{k})} \nex(P, C') \wedge (\rep(P, C') \vee \del(P,C'))$$ will be evaluated to $\false$ and with that $\ap(k,C')$ will also be evaluated to $\false$.

\item Proof of \ref{simplification_appl_5}.: Let $(R \setminus K) \cap C_{k+1} = \emptyset$ and $P \in \overlay(R, C_{k+1})$ with the morphisms $i':R \inj P$ and $i_j:C_j \inj P$ for all $j \leq k$.   
If follows that $$\bigcup_{j \leq k} i'(R\setminus K) \cap i_j(C_j\setminus C_{j-1}) = \emptyset.$$
Therefore $\rem(P,C') = \true$ for all $P \in \overlay(R, C_{k+1})$.
\end{itemize}
\end{proof}

\input{Kapitel/pot_improving_rules}
