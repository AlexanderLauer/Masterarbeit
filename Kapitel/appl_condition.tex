\section{general application conditions}

\input{figures/fig_rules}
\input{figures/fig_appl_cond}

To guarantee that each transformation $t: G \Longrightarrow_{\rho,m} H$, given a rule $\rho = L \xhookleftarrow{} K \xhookrightarrow{} R$  , is (direct) consistency increasing w.r.t to a constraint $c$, we present applications conditions ensuring this property. 
It has to be ensured that at least one violation will be removed. 
For this, it is necessary (a) to check that an occurrence $p$ of the universally bound graph $C_{\maxk{c}{G} +1}$ exists, such that $p$ and the match $m$ do overlap, i.e $p(C_{\maxk{c}{G} +1}) \cap m(L) \neq \emptyset$, and (b) that $p$ does not satisfy $c' = \exists C_{\maxk{c}{G} +2}$. 
Only in this case, it is possible that the transformation does remove a violation. 
To ensure that $p$ does not satisfy $c'$, the non-existence of all possible overlaps of $L$ and $C_{\maxk{c}{G} +2}$ such that $p \models c'$ has to be checked. 
For this, we introduce \emph{extended overlaps}.
Intuitively, given an overlap $C$ of $L$ and $C_{\maxk{c}{G} +1}$ with $p: C_{\maxk{c}{G} +1} \inj C$, the set of extended overlaps contains all overlaps $C'$ of $L$ and $C_{\maxk{c}{G} +2}$, such that $p \models c'$.


\begin{definition}[\textbf{extended overlaps}]
Let $G$, $C_0$ and $C_1$ with $i_{C_0}^{C_1}:C_0 \inj C_1$ be graphs. 
Let $C$ be an overlap of $C_0$ and $G$ with the inclusion $i_{C_0}^C : C_0 \inj C$. 
The set of \emph{extended overlaps of $C$ with $i_{C_0}^{C_1}$}, $\eol(C,i_{C_0}^{C_1})$, is the set of all overlaps $C'$ of $G$ and $C_1$, such that an injective morphism $i_C^{C'}: C \inj C'$ with $i_C^{C'} \circ i_{C_0}^C \models \exists(i_{C_0}^{C_1}: C_0 \inj C_1, \true)$ exists. 
\end{definition}


%
%\begin{definition}[\textbf{overlap shift}]
%Let $\rho = L \xhookleftarrow{} K \xhookrightarrow{} R$ be a plain rule, $C$ a graph and $C'$ an overlap of $C$ and $L$ with morphisms $p : L \inj C'$, $k: K \inj C'$, $c:C \inj C'$ and the partial morphism $q: R \inj C'$. 
%We define 
%\begin{equation}
%\begin{split}
%	D := \{e \in C' \mid &(\exists e' \in L: p(e') = e \\ &\vee \exists e' \in R: q(e') = e) \\ &\wedge \exists e' \in C: c(e') = e \}
%\end{split}
%\end{equation}
%Let $r = L \xhookleftarrow{} K' \xhookrightarrow{} R$ be the rule with 
%$$K' := K \cup D$$
%The graph $H$ derived by the transformation $G \Rightarrow_{r,p} H$ is called the \emph{overlap shifted graph of $C'$ with $C$ and  $\rho$}.
%The overlap shifted graph of an graph $C$ is denoted by $\ols_{\rho}(C,C')$.
%\end{definition} 


A direct consistency increasing application condition has to, as mentioned above, (a) ensure that at least one violation will be removed, (b) ensure that no new violations get inserted and (c) secure that the satisfaction up to layer is not decreased. 
In the definition below, $\nex()$ and $\rep()$ ensure that (a) is met, with $\nex()$ ensuring that a violation is present and $\rep()$ ensuring that this violation will be removed. Note, that the construction of these is divided in two cases. 
Firstly, either $k < \nlvl(c)-2$ or the constraints ends with a condition of the form $\exists(a: C \inj C', \true)$ and secondly, $k = \nlvl(c)-2$ and the constraint ends with a condition of the form $\forall(a: C_0 \inj C_1, \false)$.

For $\nex()$, the first case will be checked as already described above. 
In the second case, it is sufficient to check whether an occurrence $p$ of $C_k$ with $m(L) \cap p(C_k) \neq \emptyset$ exists.

For $\rep()$, in the first case, a violation can be removed by either deleting an occurrence $p$ of $C_k$ or inserting elements of $C_{k+1}$, such that $p \not \models \exists C'$ and $\track_t \circ p \models \exists C'$ for a graph $C' \in \ig{C_k}{C_{k+1}}$.
In the second case, a violation can only be removed by deleting an occurrence $p$ of $C_1$. 
This will only occur if $m(L \setminus K) \cap p(C_1) \neq \emptyset$. 

The conditions constructed by $\nin()$ and $\nwo()$ ensure that (2) is met, with $\nin()$ checking that no new occurrence of $C_k$ will be inserted and $\nwo()$ ensuring that for an occurrence $p$ of $C_k$ if $p \models \exists C'$ it is secured that $\track_t \circ p \models \exists C'$ for any $C' \in \ig{C_k}{C_{k+1}}$. 

Additionally, the conditions constructed by $\rem()$ and $\nin()$ ensure (3), with $\rem()$ ensuring that no occurrence of existentially bound graphs $C_j$ with $j \leq k$ will be deleted and $\nin()$ ensuring that no occurrences of universally bound graphs $C_j$ with $j \leq k$ will be inserted. 
With this, it is guaranteed that the satisfaction up to layer will not be decreased. 





\begin{definition}[\textbf{general application condition}]\label{def_appl_cond}
Let a rule $\rho = L \xhookleftarrow{} K \xhookrightarrow{} R$ and a constraint $c$ in UANF be given. 
Let $d = \scond{k}{c} = \forall(a_k: C_{k} \inj C_{k+1},e)$ with $0 \leq k < \nlvl(c)$ and $k$ being even.

The application condition $\apl{k}{C'}$ of $c$ at layer $k$ with 
$C' = C_{k+1}$, if $e = \false$, and $C' \in \ig{C_{k+1}}{C_{k+2}}$ otherwise is defined as:
\begin{equation}
\apl{k}{C'} := \big(\bigvee_{P \in \overlay(L,C_{k+1})} \nex(P,C') \wedge \rep(P,C')\big) \wedge \nin() \wedge \rem() \wedge \nwo()
\end{equation}

with
\begin{enumerate}
\item Let $a^r: C_{k+1} \inj C'$ be a restricted morphism of $a_{k+1}$ and $i_L^P$ and $i_P^Q$ the inclusions of $L$ in $P$ and $P$ in $Q$, respectively.
	$$\nex(P,C') := 
			\begin{cases}
			\exists (i_L^P: L \inj P, \true) &\textit{if } e = \false \\
			\bigwedge_{Q \in \eol(P,a^r)} \exists(i_L^P: L \inj P, \neg \exists(i_P^Q: P \inj Q, \true)) &\textit{otherwise}
			\end{cases}			
			$$
			
\item If $i_L^P(L \setminus K) \cap i_{C_{k+1}}^P(C_{k+1}) \neq \emptyset$, we set
$$\rep(P,C') := \true.$$
Otherwise, let $P'$ be the graph derived by the transformation $P \Longrightarrow_{\rho,m} P'$. Then, $P'$ is an overlap of $R$ and $C_k$.
If this transformation does not exist, we set 	$\rep(P,C') := \false$.
Let $a^r:C_{k+1} \inj C'$ be a partial morphism of $a_{k+1}$, then 

$$\rep(P,C') := \begin{cases}
			\false &\text{if $e = \false$}\\
			\bigvee_{Q \in \eol(P', a^p)} \shift(\exists (i_R^{Q}: R \inj Q, \true), \rho) & \text{otherwise}
		\end{cases} $$
 
\item Let $E$ be the set of all existentially bound graphs graphs $C_j$ with $j \leq k$ and let $\mathbf{P}_{C_j}$ be the set all overlaps $P'$ of $L$ and $C_j$ with $i_L^{P'}(L \setminus K) \cap i_{C_j}^{P'}(C_j) \neq \emptyset$. 
$$\rem() := \bigwedge_{C \in E} \bigwedge_{P' \in  \mathbf{P}_{C_j}} \neg \exists(i_L^{P'}: L \inj P', \true)$$

\item Let $U$ be the set of all universally bound graphs $C_j$ with $j \leq k$, and let $\mathbf{P}_{C_j} $ be the set of all overlaps $P'$ of $R$ and $C_j$ with $i_R^{P'}(R \setminus K) \cap i_{C_j}^{P'}(C_j) \neq \emptyset$.
$$\nin() := \bigwedge_{C \in U} \bigwedge_{P' \in \mathbf{P}_{C_j}} \shift(\neg \exists(i_R^{P'}: R \inj P', \true), \rho)$$

\item Let $E$ be the set of all overlaps of $L$ and $C_k$, such that each $P' \in E$ is also an overlap of $L$ and $C'' \in \ig{C_{k+1}}{ C_{k+2}}$, $i_{C_k}^{P'} \models \exists(a^r_{k+1}: C_{k+1} \inj C'', \true)$ and  $i_L^{P'}(L\setminus K) \cap i_{C''}^{P'}(C'' \setminus C_k) \neq \emptyset$.
$$\nwo() := \bigwedge_{P' \in E} \neg \exists(i_L^{P'}: L \inj P', \true) $$
\end{enumerate}
\end{definition}



Note that $\apl{k}{C'}$, for any $C' \in \ig{C_{k+1}} {C_{k+2}}$, will only be evaluated with $\true$ if an occurrence $p$ of $C_{k+1}$ with $p \not \models \exists(a_{k+1}^r:C_{k+1} \inj C', \true)$ and $\track_t \circ p \models \exists(a_{k+1}^r:C_{k+1} \inj C', \true)$ exists. 
For any smaller improvements, i.e a similar improvement for a subgraph $C'' \in \ig{C_{k+1}}{C_{k+2}}$ of $C'$, $\ap(k, C')$ would be evaluated with $\false$.
For any bigger improvements, i.e the same improvement for a supergraph $C'' \in \ig{C_{k+1}}{C_{k+2}}$ of $C'$, $\apl{k}{C'}$ would also be evaluated with $\false$, if $p \models \exists(a_{k+1}^r:C_{k+1} \inj C', \true)$.
In both cases, the application condition  would prohibit the transformation, even if it would be consistency increasing. 
To resolve this problem, multiple application conditions could be combined by 
$$\bigvee_{C' \in \ig{C_{k+1}}{C_{k+2}}} \apl{k}{C'}.$$ 
This application condition will be evaluated with $\true$ if the cases described above do appear, with the drawback that this leads to a huge condition, even if duplicate conditions are removed.
At least all duplicates of $\rem()$, $\nin()$ and $\nwo()$ can be removed, since they are identical for each $\ap(k,C')$ and only need to be constructed once.

In general, these application conditions are a trade-off between conditions-size and restrictiveness. 
They are very restrictive, since they do not allow any deletions of occurrences of existentially bound and insertions of universally bound graphs. 
For example, any of these application conditions with the rule \texttt{moveFeature} and constraint $c_1$ will be equivalent to $\false$; $\nwo()$ will always be evaluated with $\false$ since \texttt{moveFeature} does remove elements of the existentially bound graph $C_2^1$.
A change of the conditions constructed by $\nwo()$ such that it is checked whether two nodes of the type \texttt{Feature} are  connected to a node \texttt{Class} will yield application conditions that are satisfiable with \texttt{moveFeature}, but for a similar rule moving two nodes of type \texttt{Feature}, this newly constructed $\nwo()$ would still be evaluated with $\false$. 
Therefore, this only leads to a slight decrease of restrictiveness. 

The conditions constructed by $\rem()$ and $\nin()$ could be changed in a similar fashion.
For $\rem()$ and the universally bound graph $C_j$, by checking whether there does exist an additional occurrence $p$ of $C_{j+1}$ such that $p \models \scond{j+2}{\cut{\kmax}{c}}$ and for $\nin()$, by checking whether an introduced occurrence $p$ of $C_j$ does satisfy $\scond{j+1}{\cut{\kmax}{c}}$.
The construction of these is similar to the construction of consistency guaranteeing application conditions as introduced by Habel and Pennemann \cite{habel2009correctness}, which is known to construct huge application conditions. 
Also, they do get more and more restrictive for increasing $k$, since the number of conditions constructed by $\rem()$ and $\nin()$ also increases.

For constraints of the form $c:= \forall C_0 \exists C_1$ it can be shown that $\apl{0}{C_2}$ is not only a direct consistency increasing, but also a direct consistency improving application condition. 

\begin{example}
Consider the rule \emph{\texttt{assignFeature}} of figure \ref{fig:rules} and constraint $c_1$ of figure \ref{fig:constraints}. 
The application condition of $c_1$ at layer $1$ with $C_2^1$ for \emph{\texttt{assignFeature}} constructed by definition \ref{def_appl_cond} is shown in figure \ref{fig:appl_cond}.
The first two rows are conditions constructed by $\nex(\cdot, \cdot)$ and the third row is the condition constructed by $\rep(\cdot, \cdot)$.
Note that $\rem()$, $\nin()$ and $nwo()$ did not construct any conditions since \emph{\texttt{assignFeature}}  does not create elements of $C_1^1$ and does not delete elements of $C_2^1$. 

Additionally, this application condition is also a consistency improving application condition w.r.t $c_2$.
\end{example}

Let us now show that the construction above generates consistency increasing application conditions.


\begin{theorem}
Let a graph $G$, a constraint $c$ in UANF with $G \not \models c$ and a plain rule $\rho$ be given. 
Then, $\rho'= (\rho, \apl{\kmax + 1}{C})$ with $C \in \ig{C_{\kmax + 1}}{C_{\kmax+2}}$ is a consistency increasing rule.  

\end{theorem}
\begin{proof}
Let $t: G \Longrightarrow_{\rho', m} H$ be a transformation and $k = \kmax+1$. 
We show, by contradiction, that this transformation is direct consistency increasing by showing that (\ref{direct_improving_1}), (\ref{direct_improving_1_2}), (\ref{direct_improving_2}), (\ref{direct_improving_3}) and (\ref{direct_improving_4}) are satisfied. 
With that, $\rho'$ is a consistency increasing rule.
Let $\scond{k}{c} = \forall(a_k: C_k \inj C_{k+1},e)$ be the subcondition of $c$ at layer $k$. 
Let 
$$\mathbf{G} := \begin{cases}
					\ig{C_{k+1}}{C_{k+2}} & \text{if $e \neq \false$} \\
					\{C_k \} &\text{otherwise.}
				\end{cases}$$

\begin{enumerate}
\item Assume that (\ref{direct_improving_1}) does not hold. 
Then, a morphism $p: C_{k+1} \inj G$ exists, such that $p \models \ic{0}{e}{C'}$, $\track_t \circ p$ is total and $\track_t \circ p \not \models \ic{0}{e}{C'}$ for a graph $C' \in \mathbf{G}$. 
Therefore, an overlap $P$ of $L$ and $C'$ such that $i_{C_{k+1}}^P \models \exists(a^r_{k+1}: C_{k+1} \inj C', \true)$ with $i_L^P(L \setminus K) \cap i_{C'}^P(C' \setminus C_{k+1}) \neq \emptyset$ exists and $m \models \exists(i_L^P: L \inj P, \true)$ holds. 
Thus, $\nwo()$ and consequently also $\apl{k}{C}$ cannot be satisfied. 

\item Assume that  (\ref{direct_improving_1_2}) does not hold and let

$$ d := \begin{cases} 
		\ic{0}{e}{C_{k+2}} & \text{if $e \neq \false$} \\
		\false &\text{otherwise.}
	
	\end{cases}	
$$

  Then, a morphism $p': C_{k+1} \inj H$ with $p' \not \models d$ exists, such that no morphism $p :C_{k+1} \inj G$ with $\track_t \circ p = p'$ exists. 
Therefore, an overlap $P$ of $R$ and $C_{k+1}$ with $i_R^P(R\setminus K) \cap i_{C_{k+1}}^P(C_{k+1}) \neq \emptyset$ exists, such that $m \models \shift(\exists(i_R^P: R \inj P, \true), \rho)$ and $m$ does not satisfy $\nin()$. 

\item Assume that (\ref{direct_improving_2}) does not hold. 
Then, no morphism $p: C_{k+1} \inj G$ with $p \not \models \ic{0}{e}{C'}$, such that $\track_t \circ p$ is not total or $\track_t \circ p \models \ic{0}{e}{C'}$ exists, for any $C' \in \mathbf{G}$.
Then, no overlap $P$ of $L$ and $C_{k+1}$ with $i_L^P(L\setminus K) \cap i_{C_{k+1}}^P(C_{k+1}) \neq \emptyset$ exists, such that $m \models \nex(P,C)$.

Let $P$ be an overlap of $C_{k+1}$ and $L$ with $i_L^P(L \setminus K) \cap i_{C_{k+1}}^P(C_{k+1}) = \emptyset$.
If $e  = \false$, then $\rep(P,C) = \false$. 
Otherwise, if $m \models \nex(P,C) \wedge \rep(P,C)$, it holds that $i_{C_{k+1}}^P \not \models \ic{0}{e}{C}$ and a  graph $Q \in \eol(P', a^r)$ exists, such that $m \models \shift(\exists(i_R^Q:R \inj Q, \true),\rho)$. 
In this case, $\track_t \circ i_{C_{k+1}}^P \models \ic{0}{e}{C}$ follows and (\ref{direct_improving_2}) is satisfied. 

In total, $m \not \models \nex(P,C) \wedge \rep(P,C)$ follows for all $P \in \overlay(L,C_{k+1})$ and therefore $m \not \models \apl{k}{C}$.

\item Assume that (\ref{direct_improving_3}) does not hold.
Then, a morphism $p: C_j \inj H$ with $C_j$ being universally bound and  $j < k$ exists, such that no morphism $p': C_j \inj G$ with $\track_t \circ p' = p$ exists. 
Then, an overlap $P$ of $C_j$ and $R$ with $i_R^P(R \setminus K) \cap i_{C_j}^P(C_j) \neq \emptyset$ exists, such that $m \models \shift(\exists(i_R^P: R \inj P, \true), \rho)$. 
Hence, $m \not \models \nin()$ and  $m \not \models \apl{k}{ C}$. 

\item Assume that (\ref{direct_improving_4}) does not hold.
Then, a morphism $p :C_j \inj G$ with $C_j$ being existentially bound and $j < k$ exists, such that $\track_t \circ p$ is not total. 
Then, an overlap $P$ of $C_j$ and $L$ with $i_L^P(L \setminus K) \cap i_{C_j}^P(C_j) \neq \emptyset$ exists, such that $m \models \exists(i_L^P:L \inj P, \true)$. 
Hence, $m \not \models \rem()$ and  $m \not \models \apl{k}{C}$.

\end{enumerate}
In total follows, if $\models \apl{k}{C}$, then $t$ is a direct consistency increasing transformation.
\end{proof}

%\begin{lemma}
%Let $G$ be a graph, $c$ a constraint in EANF, with $\maxc{G} < \nlvl(c)-1$,  and $\rho = L \xhookleftarrow{} K \xhookrightarrow{} R$ a plain rule.
%Let $d = \forall(a_k : C_{k-1} \inj C_{k}, \exists(b: C_{k} \inj C_{k+1}, e))$ be the subcondition of $c$ at layer $\cmax + 1$ and $\ap(\maxc{G} + 1, C')$ the application condition constructed by definition \ref{def_appl_cond} with $C'\in \mathcal{U}(C, C_{k+1})$.
%If 
%$$((R \setminus K) \cap C_{k+1}) \cup ((L \setminus K) \cap C_{k+1}) = \emptyset$$
%$\ap(\cmax, C')$ can be replaced by $\false$. 
%\end{lemma}
%\begin{proof}
%There does not exist an overlap $P$ of $C_k$ and $L$ with $i_L(L \setminus K) \cap i_{C_k}(C_k) \neq \emptyset$ and $\rep(P,C')$ will be equal to $\false$, if $C_k = C_{k+1}$, or equal to $\bigvee_{P' \in \mathbf{P}} \shift(\exists(i_R: R \inj P', \true), \rho)$. 
%Since the set $\mathbf{P}$ has to be empty, this expression can be replaced by $\false$. 
%If follows that $\rep(P,C') = \false$ for all $P \in \overlay(L,C_k)$ and therefore $\ap(\cmax, C')$ will always be evaluated to $\false$.
%\end{proof}

\input{Kapitel/pot_improving_rules}
