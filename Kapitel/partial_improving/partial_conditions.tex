\subsection{conditions up to layer}
\begin{definition}[\textbf{Layer of a subcondition}]
Let $c$  be a condition and $d$ a subcondition of $c$. 
The layer of $d$ is defined as $\lay(d) := \nl(c) - \nl(d) -1$. 


\end{definition}
We define a notion of partial consistency, called \emph{satisfaction at layer}, which will be used for the definition of consistency increasing. 
First, two operators are introduced to modify given constraints on a certain layer. 

\begin{definition}[\textbf{substitution at layer}]
Let $c = Q(a: C_0 \inj C_1, d)$ be a condition in ANF, such that the subcondition of $c$ with layer $0 \leq k \leq \nl(c)$ is a condition over $C_k$. 
Let $e$ be a condition over $C_k$. 
The \emph{substitution in $c$  at layer $k$ with $e$}, $\sub(k,c,e)$, is recursively defined as:
\begin{enumerate}
\item If $k \leq 1$:
		$$\sub(0, c, e) := e$$

\item If $k > 1$:
		$$\sub(k,c,e) := Q\bigl(a: C_0 \inj C_1, \sub(k-1,d,e)\bigr)$$
		
\end{enumerate}
\end{definition}

\begin{example}
Let the conditions $c := \forall(a_0: C_0 \inj C_1, \exists(a_1: C_1 \inj C_2, \true))$ and $d = \exists(a'_1: C_1 \inj C_3, e)$ be given. 
Then, 
$$\sub(2, c,d) = \forall(a_0: C_0 \inj C_1, \exists(a'_1: C_1 \inj C_3, e)).$$ 
\end{example}

Through this, we define \emph{condition up to layer}.
Intuitively, a condition is cut off at a certain layer, by replacing the subcondition at this layer by $\true$ or $\false$, depending on the quantifier, the replaced subcondition is bound by.
\begin{definition}[\textbf{Condition up to layer}]
Let $c$ be a condition in EANF and $d$ be the subcondition of $c$ at layer $0 \leq k \leq \nl(c)$. 
The \emph{condition up to layer} $k$ of $c$, $\cond(k,c)$, is defined as

$$ \cond(k,c) := \begin{cases}
					\sub(k+1,c,\true)&\text{if $d$ is existentially bound} \\
					\sub(k+1,c,\false)&\text{if $d$ is universally bound.} \\
				\end{cases}$$

\end{definition}

\begin{example}
Let the condition $c = \forall(a_0: C_0 \inj C_1, \exists(a_1:C_1 \inj C_2, d))$ be given. 
Then,
$$ \cond(2,c) = \forall(a_0: C_0 \inj C_1, \true).$$
\end{example}
Now, we are ready to define satisfaction at layer, which is a key ingredient to define consistency increasing. 
\begin{definition}[\textbf{Satisfaction at layer}]
Let $G$ be a graph and $c$ be a condition over $C_0$. 
A morphism $p: C_0 \inj G$ \emph{satisfies $c$ at layer $k$}, $p \models_k c$, if $$p\models \cond(k,c).$$

A graph $G$ satisfies a constraint $c$ at layer $k$, $G \models_k c$, if $q: \emptyset \inj G$ satisfies $\cond(k,c)$.
The biggest $k$ with $G \models_k c$ such that no $j >k$ with $G \models_j c$ exists is denoted by $\maxc{G}$.
\end{definition}

\begin{example}
\end{example}


The following lemmas arise as a direct consequence of the definition of satisfaction at layer. 
If a graph satisfies a constraint up to a certain layer, let $c$ be this condition up to this layer, that ends with  $\forall(a: C \inj C', \false)$, the graph satisfies all constraints starting with $c$. 

\begin{lemma}\label{lemma_help_lay_sat}
Let $G$ be a graph $p: C_0 \inj G$ a morphism and $c$ a condition over $C_0$ in ANF with $p \models_k c$.
If the subcondition $d = Q(a_k:C_{k-1} \inj C_k, e)$ of $c$ at layer $k$ is universally bound, then for any condition $f$ over $C_k$ it holds that
$$p \models \sub(k,c,f).$$
\end{lemma}




\begin{proof}
Let $k$ be the smallest number such that $p \models_k c$ and the subcondition of $c$ with layer $k$ is universally bound, let $d = \forall(a_k: C_{k-1} \inj C_k, e)$ be this subcondition.
Let $q: G_{k-1} \to G$ be a morphism such that $q \models \forall(a_k:C_{k-1} \inj C_k, \false)$. 
This must exist, since $p \models_k c$ and $k$ is the smallest number such that $p \models_k v$ and the subcondition of $c$ with layer $k$ is universally bound. 

Therefore, there does not exist a morphism $q': C_k \to G$ with $q = q' \circ a_k$.
Hence, for every condition $f$ over $C_k$ a morphism $q': C_k \to G$ with $q \not \models f$ and $q = q' \circ a_k$ cannot exist. 
It follows immediately that $q \models \forall(a_k:C_{k-1} \inj C_k, f)$.
\end{proof}

As a direct consequence of the previous lemma, a graph satisfying a condition up to layer ending with $\forall(a: C \inj C', \false)$ also satisfies the whole constraint. 

\begin{lemma}\label{lemma_lay_sat}

Let $G$ be a graph, $p: C_0 \to G$ a morphism and $c$ a condition over $C_0$ in ANF with $p \models_k c$.
If the subcondition $d$ of $c$ with $\lay(d) = k$ is universally bound, $$p \models_k c \implies p \models c.$$
\end{lemma}
\begin{proof}
Follows immediately by using lemma \ref{lemma_help_lay_sat} and setting $f$ to the subcondition of $c$ with layer $k+1$.
\end{proof}



\begin{lemma}\label{lemma_part_satisfiability}
	Let $c$ be a condition in ANF over $C_0$ and $p: C_0 \inj G$ a morphism with $p \models_k c$. 
	Let $d = Q(a_{k+2}: C_{k+1} \inj C_{k+2},e)$ be the subcondition of $c$ with layer $k+2$. 
	There does exist a graph $C_{k+1} \subseteq C' \subseteq C_{k+2}$ such that $$p \models \sub\bigl(k+1,c,Q(a_{k+2}: C_{k+1} \inj C',f)\bigr)$$ with $f$ being a $\overline{Q}$ bound condition over $C'$.
\end{lemma}
\begin{proof}
If $p \models c$, we can choose $C' = C_{k+2}$ and $f = e$.

If $p \not \models c$, there does not exists a $j$ with $p \models_j c$ and the subcondition of $c$ with layer $j$ is universally bound and $Q = \exists$ follows immediately.
We choose $C' = C_{k+1}$ and $f = \true$. Let $q: C_{k} \to G$ with $p = q \circ a_k \circ \ldots \circ a_1$ and $q \circ \ldots \circ a_{\ell}$ satisfying the condition up to $\ell - k$ of the subcondition of $c$ at layer $\ell$  for all $0 \leq \ell \leq k$.
This morphism must exists since $p \models_k c$ and $p \not \models c$. 
Let $q': C_{k+1} \to G$ be a morphism with $q = q' \circ a_{k+1}$.  Since $C' = C_{k+1}$, the morphism $a'_{k+2}$ has to be the identity and therefore $q' = q' \circ a'_{k+2}$. It follows that $q' \models \exists(a'_{k+2}: C_{k+1} \inj C', \true)$ and therefore $p \models \sub\bigl(k+1,c,Q(a_{k+2}: C_{k+1} \inj C',f)\bigr)$.
\end{proof}


\begin{definition}[\textbf{partial condition}]
Let $c$ be a condition in ANF over $C_0$. 
Let $d$ be the subcondition of $c$ at layer $k +1$. 
The \emph{partial condition of $c$ at layer $k$ with $C'$}, $\parcond(k,c,C')$ is defined as:
\begin{enumerate}
\item If $d$ is universally bound, let $e = \exists(a: C_{k+1} \inj C_{k+2},f)$ be the subcondition of $c$ at layer $k+2$ with $C_{k+1} \subseteq C' \subseteq C_{k+2}$:
$$\parcond(k,c,C') := \sub\bigl(k+2,c,\exists(a:C_{k+1} \inj C', \true)\bigr)$$
\item If $d = \exists(a:C_k\inj C_{k+1},f)$ is existentially bound with $C_{k} \subseteq C' \subseteq C_{k+1}$:
$$\parcond(k,c,C') := \sub\bigl(k+1,c,\exists(a:C_{k+1} \inj C', \true)\bigr)$$
\end{enumerate}
\end{definition}

\begin{definition}[\textbf{biggest partially satisfying condition}]
Let $G$ be a graph, $c$ a condition over $C_0$ and $p : C_0 \inj G$ a morphism with $p \models_k c$. 

A partial condition $c = \parcond(c_{\max},c,C')$ with $p \models c$ is a \emph{biggest partially satisfying condition} if there does not exist a graph $C' \subset C''$ with $p \models \parcond(c_{max},c,C'')$. 
The graph $C'$ is called a \emph{biggest partially satisfying graph}.

The set of biggest partially satisfying conditions of $c$ is denoted by $\mathcal{P}_c^G$. 

The set of all biggest partially satisfying graphs is denoted by $\mathcal{G}_{c}^G$. 
\end{definition}