\subsection{Conditions up to layer}
\input{figures/fig_constraints}
\input{figures/fig_graph}
\begin{definition}[\textbf{Layer of a subcondition}]
Let $c$  be a condition and $d$ a subcondition of $c$. 
The layer of $d$ is defined as $\lay(d) := \nlvl(c) - \nlvl(d)$. 
\end{definition}

 
\begin{definition}[\textbf{Subcondition at layer}]
Let $c$ be a condition. 
The \emph{subcondition at layer $k$}, denoted by $\scond{k}{c}$ , is the subcondition $d$ of $c$ with $\lay(d) = k$.
\end{definition}

For the rest of this paper, given a constraint $c$ in UANF, $\scond{k}{c}$ is always a condition over the graph $C_k$, for all $0 \leq k \leq \nlvl(c)$.

We define a notion of partial consistency, called \emph{satisfaction at layer}, which will be used for the definition of consistency increasing. 
First, two operators are introduced to modify given constraints on a certain layer. 

\begin{definition}[\textbf{Replacement at layer}]
Let a condition $c = Q(a: C_0 \inj C_1, d)$, with $Q \in \{\forall, \exists\}$ in ANF and a condition $e$ over $C_k$ in ANF be given. 
The \emph{replacement in $c$  at layer $k$ with $e$}, $\repl{k}{c}{e}$, is recursively defined as:
\begin{enumerate}
\item If $k = 0$:
		$$\repl{0}{c}{e} := e$$

\item If $k > 0$:
		$$\repl{k}{c}{e} := Q\bigl(a: C_0 \inj C_1, \repl{k-1}{d}{e}\bigr)$$
		
\end{enumerate}
\end{definition}

\begin{example}
Let the conditions $c := \forall(a_0: C_0 \inj C_1, \exists(a_1: C_1 \inj C_2, \true))$ and $d = \exists(a'_1: C_1 \inj C_3, e)$ be given. 
Then, 
$$\repl{1}{c}{d} = \forall(a_0: C_0 \inj C_1, \exists(a'_1: C_1 \inj C_3, e)).$$ 
\end{example}

Through this, we define \emph{truncated conditions}.
Intuitively, a condition is cut off at a certain layer, by replacing the subcondition at this layer by $\true$ or $\false$, depending on the quantifier, the replaced subcondition is bound by.
\begin{definition}[\textbf{Truncated condition}]
Let $c$ be a condition in UANF and $d = \scond{k}{c}$ with $ 0 \leq k \leq \nlvl(c)$. 
The \emph{truncated condition up to layer} $k$ of $c$, $\cut{k}{c}$, is defined as

$$ \cut{k}{c} := \begin{cases}
					\repl{k+1}{c}{\true}&\text{if $d$ is existentially bound} \\
					\repl{k+1}{c}{\false}&\text{if $d$ is universally bound.} \\
				\end{cases}$$

\end{definition}

\begin{example}
Consider constraint $c_2$ given in figure \ref{fig:constraints}.
Then, $\cut{1}{c_2} = \forall C_1^1 \exists C_2^2$
\end{example}
Now, we are ready to define satisfaction at layer, which is a key ingredient for our notion of consistency increasement.
\begin{definition}[\textbf{Satisfaction at layer}]
Let a graph $G$ and a condition $c$ in UANF be given.
A morphism $p: C_0 \inj G$ \emph{satisfies $c$ at layer $k$}, $p \models_k c$, if $$p\models \cut{k}{c}.$$

A graph $G$ satisfies a constraint $c$ at layer $k$, $G \models_k c$, if $q: \emptyset \inj G$ satisfies $\cut{k}{c}$.
The biggest $0 \leq k \leq \nlvl(c)$ such that $G \models_k c$ and no $k < j \leq \nlvl(c)$ with $G \models_j c$ exists is denoted by $\maxk{c}{G}$.
We use the abbreviation $\kmax$ when $c$ and $G$ are clear from the context.
\end{definition}

\begin{example}
Consider the graph $G$ given in figure \ref{fig:graph} and the constraint $c_2$ given in figure \ref{fig:constraints}. 
This graph does not satisfy $c_2$, since both occurrences of \emph{\texttt{Class}} do not satisfy $\exists C_2^2 \forall C_3^2 \exists C_4^2$, but is does satisfy $\cut{1}{c_2}$ and therefore $$G \models_1 c_2 \text{ and } \kmax = 1$$
\end{example}


The following lemmas arise as a direct consequence of the definition of satisfaction at layer. 
If a graph satisfies a constraint up to a certain layer, let $c$ be this condition up to this layer, that ends with  $\forall(a: C \inj C', \false)$, the graph satisfies all constraints starting with $c$. 

\begin{lemma}\label{lemma_help_lay_sat}
Let a graph $G$, a condition $c$ in UANF and a morphism $p : C_0 \inj G$ with $p \models_k c$ be given.
If the subcondition $d = \scond{k}{c}$ is universally bound, then for any condition $f$ over $C_{k+1}$ it holds that
$$p \models \repl{k + 1}{c}{f}.$$
\end{lemma}




\begin{proof}
Let $0 \leq k \leq \nlvl(c)$ be the smallest number with  $\scond{k}{c} = \forall(a_k:C_{k} \inj C_{k+1}, d)$ being universally bound and $p \models_k c$.
Let $q: C_{k} \inj G$ be a morphism such that $q \models \forall(a_k:C_{k} \inj C_{k+1}, \false)$. 
This must exist, since $p \models_k c$ and $k$ is the smallest even number such that $p \models_k c$.
Therefore, there does not exist a morphism $q': C_{k+1} \inj G$ with $q = q' \circ a_k$.
Hence, for every condition $f$ over $C_{k+1}$ a morphism $q': C_{k+1} \inj G$ with $q \not \models f$ and $q = q' \circ a_k$ cannot exist. 
It follows immediately that $q \models \forall(a_k:C_{k-1} \inj C_k, f)$ and with that $p \models \repl{k + 1}{c}{f}$.

It follows that for every even $k < j \leq \nlvl(c)$, such that $p \models_j c$, and every condition $d$ over $C_{j + 1}$ it holds that $p \models \repl{k + 1}{c}{f}$ with $f = \repl{j-k + 1}{\scond{k+1}{c}}{d}$.
Since $\repl{k+1}{c}{f} = \repl{j+1}{c}{d}$ it follows that $p \models \repl{j + 1}{c}{d}$.
\end{proof}

As a direct consequence of the previous lemma, a graph satisfying a condition up to layer ending with $\forall(a: C \inj C', \false)$ also satisfies the whole constraint. 

\begin{lemma}\label{lemma_lay_sat}

Let $G$ be a graph, $p: C_0 \inj G$ a morphism and $c$ a condition over $C_0$ in UANF with $p \models_k c$.
If $\scond{k}{c}$ is universally bound, $$p \models_k c \implies p \models c.$$
\end{lemma}
\begin{proof}
Follows immediately by using lemma \ref{lemma_help_lay_sat} and setting $f$ to $\scond{k+1}{c}$.
\end{proof}



%\begin{lemma}\label{lemma_part_satisfiability}
%	Let $c$ be a condition in ANF over $C_0$ and $p: C_0 \inj G$ a morphism with $p \models_k c$. 
%	Let $d = Q(a_{k+2}: C_{k+1} \inj C_{k+2},e)$ be the subcondition of $c$ with layer $k+2$. 
%	There does exist a graph $C_{k+1} \subseteq C' \subseteq C_{k+2}$ such that $$p \models \sub\bigl(k+1,c,Q(a_{k+2}: C_{k+1} \inj C',f)\bigr)$$ with $f$ being a $\overline{Q}$ bound condition over $C'$.
%\end{lemma}
%\begin{proof}
%If $p \models c$, we can choose $C' = C_{k+2}$ and $f = e$.
%
%If $p \not \models c$, there does not exists a $j$ with $p \models_j c$ and the subcondition of $c$ with layer $j$ is universally bound and $Q = \exists$ follows immediately.
%We choose $C' = C_{k+1}$ and $f = \true$. Let $q: C_{k} \to G$ with $p = q \circ a_k \circ \ldots \circ a_1$ and $q \circ \ldots \circ a_{\ell}$ satisfying the condition up to $\ell - k$ of the subcondition of $c$ at layer $\ell$  for all $0 \leq \ell \leq k$.
%This morphism must exists since $p \models_k c$ and $p \not \models c$. 
%Let $q': C_{k+1} \to G$ be a morphism with $q = q' \circ a_{k+1}$.  Since $C' = C_{k+1}$, the morphism $a'_{k+2}$ has to be the identity and therefore $q' = q' \circ a'_{k+2}$. It follows that $q' \models \exists(a'_{k+2}: C_{k+1} \inj C', \true)$ and therefore $p \models \sub\bigl(k+1,c,Q(a_{k+2}: C_{k+1} \inj C',f)\bigr)$.
%\end{proof}


\begin{lemma}\label{lem_ex_lower}
Let a graph $G$, a morphism $p: C_0 \inj G$ and a constraint $c$ in UANF be given.
Then, $p \models_j c$ if $j < \kmax$ and $\scond{j}{c}$ is existentially bound. 

\end{lemma}
\begin{proof}
\begin{enumerate}
	\item The subcondition of $c$ at layer $\maxc{G}$ is existentially bound:	
	If a $j < \maxc{G}$ with $p \models_j c$ exists such that $\scond{c}{j}$ is universally bound, let $j_1$ be the smallest of these. With lemma \ref{lemma_help_lay_sat} follows that $p \models_{j_2} c $ for all $j_1 < j_2$.
	Let $\ell < j_1$, such that $\scond{c}{\ell}$ is existentially bound and let $d = \exists(a_{\ell}: C_{\ell} \inj C_{\ell+1}, e)$ be the condition up to layer $j_1 - \ell$ of $\scond{c}{\ell}$. 
	Since $\ell < j_1$, a morphism $q:  C_{\ell} \inj G$ with $q \models d$ must exists and therefore a morphism $q': C_{\ell +1}\inj G$ with $q = q' \circ a_k$ must exists. 
	It follows that $q \models \exists(a_{\ell}: C_{\ell} \inj C_{\ell+1}, \true)$ and with that $p \models_{\ell} c$.
	
	\item The subcondition of $c$ at layer $\maxc{G}$ is universally bound:
	With lemma \ref{lemma_help_lay_sat} follows that $p \models_{k+1} c$. 
	Since $c$ is in EANF,  $1.$ can be applied  to $k+1$. 
\end{enumerate}
\end{proof}

Through satisfaction at layer an increase of consistency can be detected in the following way. 
Let $G \Longrightarrow H$ be a transformation. 
If $\maxc{G} < \maxc{H}$, the transformation can be considered as consistency increasing, since $H$ satisfies more layers of the constraint than $G$. 
The notion of consistency increasing should also be able to detect the smallest transformations that lead to a increase of consistency, namely the inserting of a single edge or node of an existentially bound graph.
To remedy this issue, we introduce \emph{partial conditions}.
Intuitively, given a constraint $c$ in EANF ending with $\scond{c}{k} =\exists(a_k :C_k \inj C_{k+1}, d)$, the condition $\scond{c}{k}$ is replaced by $\exists(a^p_k: C_k \inj C', \true)$ with $C' \in \mathcal{U}(C_k, C_{k+1})$.

The construction of partial conditions is designed to only replace graphs in existentially bound layers, since the replacement in an universally bound layer would lead to a more restrictive constraint than the original condition up to layer. 
That means, given the condition $c = \forall(a_0: C_0 \inj C_1, \false)$ and let $C' \in \mathcal{U}(C_0, C_1)$. 
If the condition $c'= \forall(a^p_0: C_0 \inj C_1, \false)$ is satisfied this implies that $c$ is also satisfied but the backwards implication does not hold.

\begin{definition}[\textbf{partial condition}]
Let a constraint $c$ in ANF be given. 
Let $k \leq \nlvl(c)+1$ such that either $\scond{c}{k} = \exists(a_k:C_{k-1} \inj C_k, d)$ is existentially bound or $k = \nlvl(c) +1$.
The \emph{partial condition, $\parcond(k,c,C')$, of $c$ at layer $k$ with} 
$$C' \in \begin{cases}
			\mathcal{U}(C_k, C_{k+1}) &\text{if $k \leq \nlvl(c)$}\\
			C_{\nlvl(c)} &\text{otherwise}
		\end{cases}
$$

is defined as:
$$\parcond(k,c,C') := \begin{cases}
							c & \text{if $k = \nlvl(c)+1$}\\
							\sub\big(k,c,\exists(a_k^p:C_{k-1} \inj C', \true) \big) &\text{otherwise}
					   \end{cases}$$

\end{definition}

%\begin{definition}[\textbf{partial condition}]
%Let $c$ be a condition in EANF. 
%
%The \emph{partial condition of $c$ at layer $k < \nlvl(c)$ with} with 
%$$ C' \in \begin{cases}
%			\mathcal{U}(C_k, C_{k+1}) &\text{if $k$ is even} \\
%			\mathcal{U}(C_{k+1}, C_{k+2}) &\text{if $k$ is odd},
%		   \end{cases}
%$$
%$\parcond(k,c,C')$, is defined as:
%\begin{enumerate}
%\item If $k$ is odd, let $\scond{c}{k+1} = \exists(a: C_{k+1} \inj C_{k+2},f)$:
%$$\parcond(k,c,C') := \sub\bigl(k+1,c,\exists(a^p:C_{k+1} \inj C', \true)\bigr)$$
%\item If $k$ is even, let $\scond{c}{k+1} = \exists(a:C_k\inj C_{k+1},f)$:
%$$\parcond(k,c,C') := \sub\bigl(k,c,\exists(a^p:C_{k+1} \inj C', \true)\bigr)$$
%\end{enumerate}
%\end{definition}

\begin{example}
Consider constraint $c_1$ given in figure \ref{fig:constraints}. 
Since $C_2^2 \in \mathcal{U}(C_1^1,C_1^2)$, we can construct a partial condition of $c_1$ at layer $2$ with $C_2^2$ as $\parcond(2,c_1,C_2^2) = \forall C_1^1 \exists C_2^2$. 
Whereas $c_2$ checks whether each node of the type \emph{\texttt{Class}} is connected to at least two nodes of the type \emph{\texttt{Feature}}, the partial condition checks whether each nodes of the type \emph{\texttt{Class}} is connected to at least one nodes of the type \emph{\texttt{Feature}}.
\end{example}


If a graph $G$ does not satisfy the condition up to layer $k := \maxc{G} + 2$, $k < \nlvl(c) +1$, of a given constraint $c$, with $\scond{c}{k}$ being existentially bound, there does exists a graph $C' \in \mathcal{U}(C_{k-1}, C_k)$, such that $G$ satisfies $\parcond(k,c,C')$, note that $G$ always satisfies $\parcond(k,c,C_{k-1})$. 
For the biggest of these graphs, we define the notions of \emph{biggest partially satisfying conditions and graphs}.


\begin{definition}[\textbf{biggest partially satisfying condition}]
Let $G$ be a graph, $c$ a condition in EANF over $C_0$ and $p : C_0 \inj G$ a morphism with $p \models_k c$ and $p \not \models c$. 

A partial condition $c = \parcond(k+2,c,C')$ with $p \models c$ is a \emph{biggest partially satisfying condition w.r.t $c$ of $p$} if there does not exist a graph  $C''$, such that $C'$ is a subgraph of $C''$, with $p \models \parcond(c_{max},c,C'')$. 
The graph $C'$ is then called a \emph{biggest partially satisfying graph w.r.t $c$ of $p$}.

Given a constraint $c$, the set of biggest partially satisfying conditions w.r.t $c$ of $p: \emptyset \inf G$ is denoted by $\mathcal{P}_c^G$. 

The set of all biggest partially satisfying graphs w.r.t $c$ of $p$ is denoted by $\mathcal{G}_{c}^G$. 
\end{definition}