\subsection{minimal consistency improving}

\begin{definition}[\textbf{Layer of a subcondition}]
Let $c$  be a condition and $d$ a subcondition of $c$. 
The layer of $d$ is defined as $\lay(d) := \nl(c) - \nl(d) -1$. 


\end{definition}

\begin{definition}[\textbf{substitution at layer}]
Let $c$ be a condition, such that the subcondition of $c$ with layer $0 \leq k \leq \nl(c)$ is an condition over $C_k$. 
Let $e$ be a condition over $C_k$. 
The \emph{substitution of $c = Q(a: C_0 \inj C_1, d)$ at layer $k$ with $e$}, $\sub(k,c,e)$, is recursively defined as:
\begin{enumerate}
\item If $k = 0$:
		$$\sub(0, c, e) := e$$

\item If $k > 0$:
		$$\sub(k,c,e) := Q\bigl(a: C_0 \inj C_1, \sub(k-1,d,e)\bigr)$$
		
\end{enumerate}
\end{definition}


\begin{definition}[\textbf{Condition up to layer}]
Let $c$ be a condition and $d$ be the subcondition of $c$ at layer $0 \leq k \leq \nl(c)$. 
The \emph{condition up to layer} $k$ of $c$, $\cond(k,c)$ is defined as

$$ \cond(k,c) := \begin{cases}
					\sub(k,c,\true)&, \text{if } k = 0 \vee \text{$d$ is existentially bound} \\
					\sub(k,c,\false)&, \text{if $d$ is universally bound.} \\
				\end{cases}$$

\end{definition}


\begin{definition}[\textbf{Satisfaction up to layer}]
Let $G$ be a graph and $c$ be a condition over $C_0$. 
A morphism $p: C_0 \inj G$ \emph{satisfies $c$ up to layer $k$}, $p \models_k c$, if $p$ satisfies $\cond(k,c)$.

A graph $G$ satisfies a constraint $c$ up to layer $k$, $G \models_k c$, if $q: \emptyset \inj G$ satisfies $\cond(k,c)$.
\end{definition}


%\begin{lemma}\label{lemma_help_lay_sat}
%Let $G$ be a graph $p: C_0 \to G$ a morphism and $c = Q(a_1: C_0 \inj C_1, \overline{Q}(a_2: C_1 \inj C_2, \ldots))$ a condition over $C_0$ in ANF with $p \models_k c$.
%If the subcondition $d = \forall(a_k: C_{k-1} \inj C_k,e)$ of $c$ at layer $k$ is universally bound, $p \models Q(a_1: C_0 \inj C_1, \overline{Q}(a_2: C_1 \inj C_2, \ldots \forall(a_k: C_{k-1} \inj C_k,f)))$ for every condition $f$ over $C_k$.
%\end{lemma}
\begin{lemma}\label{lemma_help_lay_sat}
Let $G$ be a graph $p: C_0 \inj G$ a morphism and $c$ a condition over $C_0$ in ANF with $p \models_k c$.
If the subcondition $d = Q(a_k:C_{k-1} \inj C_k, e)$ of $c$ at layer $k$ is universally bound, then for any condition $f$ over $C_k$ holds:
$$p \models \sub(k,c,f)$$
\end{lemma}




\begin{proof}
Let $k$ be the smallest number such that $p \models_k c$ and the subcondition of $c$ with layer $k$ is universally bound, let $d = \forall(a_k: C_{k-1} \inj C_k, e)$ be this subcondition.
Let $q: G_{k-1} \to G$ be a morphism such that $q \models \forall(a_k:C_{k-1} \inj C_k, \false)$. 
This must exist, since $p \models_k c$ and $k$ is the smallest number such that $p \models_k v$ and the subcondition of $c$ with layer $k$ is universally bound. 

Therefore, there does not exist a morphism $q': C_k \to G$ with $q = q' \circ a_k$.
Hence, for every condition $f$ over $C_k$ a morphism $q': C_k \to G$ with $q \not \models f$ and $q = q' \circ a_k$ cannot exist. 
It follows immediately that $q \models \forall(a_k:C_{k-1} \inj C_k, f)$.
\end{proof}



\begin{lemma}\label{lemma_lay_sat}

Let $G$ be a graph, $p: C_0 \to G$ a morphism and $c$ a condition over $C_0$ in ANF with $p \models_k c$.
If the subcondition $d$ of $c$ with $\lay(d) = k$ is universally bound, $$p \models_k c \implies p \models c.$$
\end{lemma}
\begin{proof}
Follows immediately by using lemma \ref{lemma_help_lay_sat} and setting $f$ to the subcondition of $c$ with layer $k+1$.
\end{proof}



\begin{lemma}\label{lemma_part_satisfiability}
	Let $c$ be a condition in ANF over $C_0$ and $p: C_0 \inj G$ a morphism with $p \models_k c$. 
	Let $d = Q(a_{k+2}: C_{k+1} \inj C_{k+2},e)$ be the subcondition of $c$ with layer $k+2$. 
	There does exist a graph $C_{k+1} \subseteq C' \subseteq C_{k+2}$ such that $$p \models \sub\bigl(k+1,c,Q(a_{k+2}: C_{k+1} \inj C',f)\bigr)$$ with $f$ being a $\overline{Q}$ bound condition over $C'$.
\end{lemma}
\begin{proof}
If $p \models c$, we can choose $C' = C_{k+2}$ and $f = e$.

If $p \not \models c$, there does not exists a $j$ with $p \models_j c$ and the subcondition of $c$ with layer $j$ is universally bound and $Q = \exists$ follows immediately.
We choose $C' = C_{k+1}$ and $f = \true$. Let $q: C_{k} \to G$ with $p = q \circ a_k \circ \ldots \circ a_1$ and $q \circ \ldots \circ a_{\ell}$ satisfying the condition up to $\ell - k$ of the subcondition of $c$ at layer $\ell$  for all $0 \leq \ell \leq k$.
This morphism must exists since $p \models_k c$ and $p \not \models c$. 
Let $q': C_{k+1} \to G$ be a morphism with $q = q' \circ a_{k+1}$.  Since $C' = C_{k+1}$, the morphism $a'_{k+2}$ has to be the identity and therefore $q' = q' \circ a'_{k+2}$. It follows that $q' \models \exists(a'_{k+2}: C_{k+1} \inj C', \true)$ and therefore $p \models \sub\bigl(k+1,c,Q(a_{k+2}: C_{k+1} \inj C',f)\bigr)$.
\end{proof}

\begin{definition}[\textbf{biggest partially satisfying graph}]
Let $G$ be a graph, $c = Q(a_1: C_0, \inj C_1, \ldots)$ a condition in ANF and $p: C_0 \to G$ a morphism with $p \models_k c$. 
Let $d = Q'(a_{k+1}: C_{k} \inj C_{k+1}, \overline{Q'}(a_{k+2}: C_{k+1} \inj C_{k+2},e)$ be the subcondition of $c$ with $\lay(d) = k+1)$.
	With lemma \ref{lemma_part_satisfiability} there exists a graph $C_{k+1} \subseteq C' \subseteq C_{k+2}$ and an $Q'$ bound condition $e$ over $C'$ in ANF with $p \models  Q(a_1: C_0, \inj C_1, \ldots Q'(a_{k+1}: C_{k} \inj C_{k+1}, \overline{Q}(a_{k+2}: C_{k+1} \inj C',e)) =: d_{C',e}$. 	
Let $\mathcal{C}_{k,p,e}$ be the set of graphs $C_{k+1} \subseteq C' \subseteq C_{k+2}$ with  $p \models d_{C',e}$.

A graph $C' \in \mathcal{C}_{k,p,e}$, such that no $C'' \in \textsc{C}$ with $C' \subseteq C''$ exists is called a \emph{biggest partially
 satisfying graph} of $c$ at level $k$ with $p$ and $e$.
The set of these graphs is denoted by $\mathcal{B}_{k,e}$
\end{definition}


\begin{definition}
 Let $G$ be a graph and $c $ a constraint in ANF, such that $G \models_k c$ and $G \not \models c$.
 Let $d = \forall(a_{k+1}: C_k \inj C_{k+1},e)$ be the condition up to layer $k +2$ of of the condition at layer $k+1$ of $c$.
 The number of violations of $c$ up to layer $k+2$ in $G$ is defined as the the number of morphisms $q: C_{k+1} \to G$ that do not satisfy $e$, with $C'$ being a smallest graph such that $C \subset C'$ for at least one $C \in \mathcal{B}_{k,\true}$ if $G \not \models_{k+2} c$ and $0$ otherwise. This number is denoted by $\nvc(k +2, G)$.
\end{definition}


\begin{definition}[\textbf{minimal consistency improving}]
	Let $G$ be a graph, $r$ a rule and $c$ a constraint in ANF with $G \models_k c$ and $G\not \models c$. 

	
	A transformation $G \xRightarrow{r,m} H$ is called \emph{minimal consistency improving}, if  $$\nvc(k, H) < \nvc(k, G).$$
	A rule $r$ is called \emph{minimal consistency improving}, if all of its applications are. 
	
\end{definition}

\begin{lemma}\label{lem_ex_lower}
Let $G$ be $p: C_0 \to G$ a morphism, $c$ a constraint in ANF over $C_0$ with $p \models_k c$.
Then $p \models_j c$ for all $j < k$ such that the subcondition of $c$ at layer $j$ is existentially bound. 

\end{lemma}
\begin{proof}
\begin{enumerate}
	\item The subcondition of $c$ at layer $k$ is existentially bound:	
	If an $j < k$ with $p \models_j c$ exists such that the subcondition of $c$ at layer $j$ is universally bound, let $j_1$ be the smallest of these. With lemma \ref{lemma_help_lay_sat} follows that $p \models_{j_2} c $ for all $j_1 < j_2$.
	Let $\ell < j_1$, such that the subcondition of $c$ at layer $j$ is existentially bound and let $d = \exists(a_{\ell}: C_{\ell} \inj C_{\ell+1}, e)$ be the condition up to layer $j_1 - \ell$ of the subcondition of $c$ at layer $\ell$. 
	Since $\ell < j_1$, a morphism $q:  C_{\ell} \to G$ with $q \models d$ must exists and therefore a morphism $q': C_{\ell +1}\to G$ with $q = q' \circ a_k$ must exists. 
	If follows that $q \models \exists(a_{\ell}: C_{\ell} \inj C_{\ell+1}, \true)$ and with that $p \models_{\ell} c$.
	
	\item The subcondition of $c$ at layer $k$ is universally bound:
	With lemma \ref{lemma_help_lay_sat} follows that $p \models_{k+1} c$. 
	Since $c$ is in ANF  $1.$ can be applied  to $k+1$. 
\end{enumerate}
\end{proof}

\begin{lemma}
	Let $G$ be a graph, $r$ a rule and $c$ a constraint in ANF  with $G \not \models c$. 
	Let $k$ be the biggest number, such that $G \models_k c$.
	A transformation $G \xRightarrow{r,m} H$ is minimal consistency improving if $G \models_j c$ and  $k < j$.
	
\end{lemma}

\begin{proof}
Since $G \not \models c$, with lemma \ref{lemma_lay_sat} follows that the subcondition of $c$ at layer $k$ has to be existentially bound and since $k$ is the biggest number such that $G\models_k c$ it follows that $\nvc(k+1,G) > 0$.
If the subcondition of $c$ at layer $j$ is universally bound, $H \models c$ follows with lemma  \ref{lemma_lay_sat} and lemma \ref{lem_ex_lower} $H \models_{k+2} c$. Therefore $\nvc(k+2,H) = 0$. 
Otherwise the subcondition of $c$ at layer $j$ is existentially bound and therefore $G \models_{k+2} c$ and $\nvc(k+2,H) = 0$ follows immediately.
\end{proof}

\begin{definition}[\textbf{direct minimal consistency improving}]
Let $G$ be a graph, $r$ a plain rule and $c$ a constraint in ANF with $G \models_k$ and $G \not \models c$. 
Let $d = \forall(a_k: C_k \inj C_{k+1}, e)$ be the condition at layer $k$ of $c$. 
A transformation $t: G \xRightarrow{r,m} H$ is called \emph{direct minimal consistency improving} if the transformation is minimal consistency improving and 
\begin{equation}
\begin{split}
	& \forall p: C_{k+1} \inj G(( p \models e \wedge \track_t \circ p \text{ is total}) \implies \track_t \circ p \models p) \wedge \\ & \forall p': C_{k+1} \inj H (\neg \exists p : C \inj G(p' = \track_t \circ p) \implies p' \models d).
\end{split}
\end{equation}

\end{definition}
%\begin{proof}
%\begin{enumerate}
%	Since $G \not \models c$, with lemma \ref{lemma_lay_sat} follows that the subcondition of $c$ at layer $k$ has to be existentially bound. 
%	\item The subcondition of $c$ at layer $j$ is existentially bound:
%	With lemma \ref{lem_ex_lower} follows that $H \models_{k+2} c$.
%	Let $d = \exists(a_{k+2}: C_{k+1} \inj C_{k+2}, e)$ be the subcondition of $c$ with layer $k+2$.
%	The set $\mathcal{C}_{k+2,H,\true}$ contains every graph $C'$ with $C_{k+1} \subseteq C' \subseteq C_{k+2}$. 
%	Since $G \not \models_{k+2} c$, $C_{k+2} \not \in \mathcal{C}_{k+2,G,\true}$ and for every $C'' \in \mathcal{B}_{k+2,G, \true}$ it holds that $C'' \in \mathcal{C}_{k+2,H,\true}$ and $C'' \subset C_{k+2} \in \mathcal{C}_{k+2,H, \true}$.
%	
%	\item The subcondition of $c$ at layer $j$ is universally bound:
%	With lemmas \ref{lemma_help_lay_sat} and \ref{lemma_lay_sat}, $H \models_{k+2} c$ follows and $1.$ can be applied. 
%\end{enumerate}
%\end{proof}
%\begin{definition}[\textbf{minimal consistency improving}]
%Given a rule $r$, a constraint $c$ and a graph $G$ with $G \models_k c$.
%A transformation $G \xRightarrow{r,m} H$ is called \emph{minimal consistency improving} if $H \models_j c$ and $k < j$. 
%The rule $r$ is called \emph{minimal consistency improving} if all of its applications are. 
%
%\end{definition}

