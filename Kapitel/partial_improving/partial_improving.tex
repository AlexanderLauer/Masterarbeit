\subsection{minimal consistency improving}



\begin{definition}[\textbf{number of violations}]
Let $G$ be a graph and $c$ a constraint in ANF, such that $G \models_k c$ and $G \not \models c$. 
The \emph{number of violations $\nvc(k,G)$ at layer $k$ in $G$} is set to $0$ if there does exist a $j >k$ with $G \models_j c$ and otherwise:
\begin{enumerate}
\item If $k = 0$ and $c = \exists(a:C_0 \inj C_1,e)$ is existentially bound:
	$$\nvc(k,G) := |\{C' \mid G \not \models \parcond(0,c,C') \wedge C_0 \subseteq C' \subseteq C_1\}|$$
	
\item If $k \neq 0$, let $d = \forall(a_k: C_{k+1} \inj C_{k+2},e)$ be the subcondition of $c$ at layer $k+1$.
$$\nvc(k,G) := \sum_{C \in \mathcal{G}_{k,c}} \sum_{C \subset C'} |\{q \mid q:C_{k+2} \inj G \wedge q \not \models \parcond(1,e,C')\}| $$
\end{enumerate}

\end{definition}


\begin{definition}[\textbf{minimal consistency improving}]
	Let $G$ be a graph, $r$ a rule and $c$ a constraint in ANF with $G \models_k c$ and an $j >k$ with $G \models_j c$ does not exist. 

	
	A transformation $G \xRightarrow{r,m} H$ is called \emph{minimal consistency improving}, if  $$\nvc(k, H) < \nvc(k, G).$$
	A rule $r$ is called \emph{minimal consistency improving}, if all of its applications are. 
	
\end{definition}

\begin{lemma}\label{lem_ex_lower}
Let $G$ be $p: C_0 \to G$ a morphism, $c$ a constraint in ANF over $C_0$ with $p \models_k c$.
Then $p \models_j c$ for all $j < k$ such that the subcondition of $c$ at layer $j$ is existentially bound. 

\end{lemma}
\begin{proof}
\begin{enumerate}
	\item The subcondition of $c$ at layer $k$ is existentially bound:	
	If an $j < k$ with $p \models_j c$ exists such that the subcondition of $c$ at layer $j$ is universally bound, let $j_1$ be the smallest of these. With lemma \ref{lemma_help_lay_sat} follows that $p \models_{j_2} c $ for all $j_1 < j_2$.
	Let $\ell < j_1$, such that the subcondition of $c$ at layer $j$ is existentially bound and let $d = \exists(a_{\ell}: C_{\ell} \inj C_{\ell+1}, e)$ be the condition up to layer $j_1 - \ell$ of the subcondition of $c$ at layer $\ell$. 
	Since $\ell < j_1$, a morphism $q:  C_{\ell} \to G$ with $q \models d$ must exists and therefore a morphism $q': C_{\ell +1}\to G$ with $q = q' \circ a_k$ must exists. 
	If follows that $q \models \exists(a_{\ell}: C_{\ell} \inj C_{\ell+1}, \true)$ and with that $p \models_{\ell} c$.
	
	\item The subcondition of $c$ at layer $k$ is universally bound:
	With lemma \ref{lemma_help_lay_sat} follows that $p \models_{k+1} c$. 
	Since $c$ is in ANF  $1.$ can be applied  to $k+1$. 
\end{enumerate}
\end{proof}

\begin{lemma}
	Let $G$ be a graph, $r$ a rule and $c$ a constraint in ANF  with $G \not \models c$. 
	Let $k$ be the biggest number, such that $G \models_k c$.
	A transformation $G \xRightarrow{r,m} H$ is minimal consistency improving if $G \models_j c$ and  $k < j$.
	
\end{lemma}

\begin{proof}
Since $G \not \models c$, with lemma \ref{lemma_lay_sat} follows that the subcondition of $c$ at layer $k$ has to be existentially bound and since $k$ is the biggest number such that $G\models_k c$ it follows that $\nvc(k+1,G) > 0$.
If the subcondition of $c$ at layer $j$ is universally bound, $H \models c$ follows with lemma  \ref{lemma_lay_sat} and lemma \ref{lem_ex_lower} $H \models_{k+2} c$. Therefore $\nvc(k+2,H) = 0$. 
Otherwise the subcondition of $c$ at layer $j$ is existentially bound and therefore $G \models_{k+2} c$ and $\nvc(k+2,H) = 0$ follows immediately.
\end{proof}

\begin{definition}[\textbf{direct minimal consistency improving}]
Let $G$ be a graph, $r$ a plain rule and $c$ a constraint in ANF with $G \models_k$ and $G \not \models c$. 
Let $d = \forall(a_k: C_k \inj C_{k+1}, e)$ be the condition at layer $k$ of $c$. 
A transformation $t: G \xRightarrow{r,m} H$ is called \emph{direct minimal consistency improving} if the transformation is minimal consistency improving and 
\begin{equation}
\begin{split}
	& \forall p: C_{k+1} \inj G(( p \models e \wedge \track_t \circ p \text{ is total}) \implies \track_t \circ p \models p) \wedge \\ & \forall p': C_{k+1} \inj H (\neg \exists p : C \inj G(p' = \track_t \circ p) \implies p' \models d).
\end{split}
\end{equation}

\end{definition}
%\begin{proof}
%\begin{enumerate}
%	Since $G \not \models c$, with lemma \ref{lemma_lay_sat} follows that the subcondition of $c$ at layer $k$ has to be existentially bound. 
%	\item The subcondition of $c$ at layer $j$ is existentially bound:
%	With lemma \ref{lem_ex_lower} follows that $H \models_{k+2} c$.
%	Let $d = \exists(a_{k+2}: C_{k+1} \inj C_{k+2}, e)$ be the subcondition of $c$ with layer $k+2$.
%	The set $\mathcal{C}_{k+2,H,\true}$ contains every graph $C'$ with $C_{k+1} \subseteq C' \subseteq C_{k+2}$. 
%	Since $G \not \models_{k+2} c$, $C_{k+2} \not \in \mathcal{C}_{k+2,G,\true}$ and for every $C'' \in \mathcal{B}_{k+2,G, \true}$ it holds that $C'' \in \mathcal{C}_{k+2,H,\true}$ and $C'' \subset C_{k+2} \in \mathcal{C}_{k+2,H, \true}$.
%	
%	\item The subcondition of $c$ at layer $j$ is universally bound:
%	With lemmas \ref{lemma_help_lay_sat} and \ref{lemma_lay_sat}, $H \models_{k+2} c$ follows and $1.$ can be applied. 
%\end{enumerate}
%\end{proof}
%\begin{definition}[\textbf{minimal consistency improving}]
%Given a rule $r$, a constraint $c$ and a graph $G$ with $G \models_k c$.
%A transformation $G \xRightarrow{r,m} H$ is called \emph{minimal consistency improving} if $H \models_j c$ and $k < j$. 
%The rule $r$ is called \emph{minimal consistency improving} if all of its applications are. 
%
%\end{definition}

