\subsection{consistency increasing transformations and rules}

With the results above, we are now ready to define the notions of \emph{consistency increasing} and \emph{direct consistency increasing}, with direct increasing being a more restrictive version of increasing, yielding the advantage that second-order logic formulas can be used in order to determine whether a transformation is (direct) consistency increasing or not. 

These notions are designed to only detect transformations that increase the consistency of the first two unsatisfied layer of a constraint $c$. 
That means, given a graph $G$ and a constraint $c$, let $k = \maxc{G}$ and $\forall(a_{k+1}: C_{k} \inj C_{k+1}, \exists(a_{k+2}: C_{k+1} \inj C_{k+2},d)) =: \scond{c}{k+1}$.  
A transformation $ t:G \Longrightarrow H$ is considered as (direct) consistency increasing if $\maxc{G} \leq \maxc{H}$, i.e. the satisfaction up to layer is not decreased, and more increasing insertions or deletions have been performed than decreasing ones. 
An increasing deletion is the deletion of an occurrence of $C_{k+1}$ that does not satisfy $\exists(a_{k+2}: C_{k+1} \inj C_{k+2},\true)$, an increasing insertion is the insertion of elements of $C_{k+2}$, such that for at least one occurrence $p$ of $C_{k+1}$ it holds that $p \not \models \exists(a^p_{k+2}: C_{k+1} \inj C',\true)$ and $\track_t \circ p \models \exists(a^p_{k+2}: C_{k+1} \inj C',\true)$ for an $C' \in \mathcal{U}(C_{k+1}, C_{k+2})$. 
A decreasing insertion is the creation of an occurrence of $C_{k+1}$ not satisfying $\exists(a_{k+2}: C_{k+1} \inj C_{k+2},\true)$ and a decreasing deletion is the deletion of elements of $C_{k+2}$ such that for an occurrence $p$ of $C_{k+1}$ with $p \models \exists(a^p_{k+2}: C_{k+1} \inj C',\true)$ it holds that $\track_t \circ p \not \models \exists(a^p_{k+2}: C_{k+1} \inj C',\true)$.

To evaluate this, we define the \emph{number of violations}.
Intuitively, for all occurrences $p$ of $C_{k+1}$ the number of graphs $C' \in \mathcal{U}(C_{k+1}, C_{k+2})$ with $p \not \models \exists C'$ is add up and it can be determined whether more increasing or decreasing actions have been performed by a transformation. 

Note, that the number of violations is defined for each layer of the constraint, but only for the first unsatisfied layer the sum is calculated as described above.
For all layer $k$ with $k \leq \maxc{G}$ it is set to $0$ and for all  layer $k$ with $k > \maxc{G} + 1$ it is set to $\infty$. 
Through this, a transformation $t G \Longrightarrow H$ that increases the partial consistency can easily detected since the number of violations in $H$ at layer $\maxc{G} + 1$ will be set to $0$. 

\begin{definition}[\textbf{number of violations}]
Let $G$ be a graph and $c$ a constraint in EANF. 
The \emph{number of violations $\nvc(j,G)$ at layer $j$ in $G$} is defined as:
\begin{enumerate}
\item If $j < \maxc{G}+1$:
	$$\nvc(j,G) := 0$$
\item If $j = c_{\max}+1$, let $d = \forall(a_k: C_{j} \inj C_{j+1},e)$ be the subcondition of $c$ at layer $j+1$.


$$\nvc(j,G) := \begin{cases}
					\sum_{C' \in \mathcal{U}(C_j,{C_{j+1}})} |\{q \mid q:C_{j+1} \inj G \wedge q \not \models \parcond(1,e,C')\}| &  \text{if $e \neq \false$}\\
					|\{q \mid q:C_{j+1} \inj G\}| & \text{if $e = \false$} 
				\end{cases}$$

\item If $j > \maxc{G}+1$:
	$$\nvc(j,G) := \infty$$
\end{enumerate}

\end{definition}

Via the number of violations, we now define \emph{consistency increasing} transformations and rules, by checking whether the number of violations has decreased for any layer of the constraint.

\begin{definition}[\textbf{consistency increasing}]
	Let a graph $G$, a rule $\rho$ and a constraint $c$ in EANF be given. 

	
	A transformation $G \Longrightarrow_{\rho,m} H$ is called \emph{consistency increasing w.r.t $c$}, if  $$\nvc(k, H) < \nvc(k, G) $$
	for any $0 \leq k \leq \nl(c)$.
	A rule $r$ is called \emph{consistency increasing w.r.t $c$}, if all of its applications are. 
	
\end{definition}

Note that if $G \models c$ there does not exist a consistency increasing transformation w.r.t $c$, since $\nvc(j,G) = 0$ for all $1 \leq j \leq \nl(c)$.
Also, no plain rule $\rho$ is  consistency increasing w.r.t $c$, since a graph $G$ satisfying $c$, such that a transformation $t: G \Longrightarrow_{\rho,m} H$ exists can always be constructed. 
Therefore, each consistency increasing rule has to be equipped with at least one application condition.

As mentioned above, a transformation should be detected as consistency increasing if it increases the partial consistency, which is shown by the following theorem. 

\begin{theorem}
	Let a graph $G$, a rule $\rho$ and a constraint $c$ in EANF be given.
	A transformation $t: G \Longrightarrow_{\rho,m} H$ is consistency increasing if $\maxc{G} < \maxc{H}$.	
\end{theorem}

\begin{proof}
No $\ell >\maxc{G}$ with $G\models_{\ell} c$ exists. Hence, $\nvc(\maxc{G} + 1,G) > 0$ and $\nvc(\maxc{G} + 1,G) \neq \infty$. 
Since $\maxc{H} > \maxc{G}$, $\nvc(k+1,H) = 0$ and it follows immediately that $t$ is consistency increasing. 
\end{proof}

Since no consistency increasing transformation originating in consistent graphs exist, there do not exist infinite long sequences of consistency increasing transformations.
Additionally, if a set of rules $\mathcal{R}$ is given, and a sequence of consistency increasing transformations with rules of $\mathcal{R}$ ends with a graph $G$, then either $G$ satisfies the constraint or there do not exist any consistency increasing transformations $G \Longrightarrow_{\rho, m} H$ with $\rho \in \mathcal{R}$.

\begin{theorem}
Let a constraint $c$ in EANF and a set of rules $\mathcal{R}$ be given. 
Every sequence of minimal consistency improving transformation w.r.t $c$ with rules in $\mathcal{R}$ is finite.

\end{theorem}

\begin{proof}
Let $G_0$ be a graph and 
$$G_0 \Longrightarrow_{\rho_1} G_1 \Longrightarrow_{\rho_2} G_2 \Longrightarrow_{\rho_3} \ldots$$
be a sequence of minimal consistency improving transformations w.r.t $c$ with $\rho_i \in \mathcal{R}$.
We assume that $\maxc{G_0} < \nl(c)$, otherwise $\nvc(j,G_0) = 0$ for all $j \in \{0, \ldots, \nl(c)\}$ and no transformation $G_0 \Longrightarrow H$ is consistency increasing. 

We show that after at most $j := \nvc(\cmax_{G_0}+1,G_0)$ transformations $G_j \models_{\maxc{G_0} + 2} c$ holds. 
Note that $j$ has to be finite, since $G_0$ contains only a finite number of occurrences of $C_{j+1}$.
After each transformation it holds that $\nvc(\maxc{G_{i+1}}+1,G_{i+1}) \leq \nvc(\maxc{G_i}+1,G_{i})-1$.
Therefore, after $j$ transformations, $\nvc(\maxc{G_0}+1,G_{j}) \leq \nvc(\maxc{G_0}+1,G_{0})-j = 0$ holds and with that $G_j \models_{\maxc{G_0}+ 2} c$.
By iteratively applying this, it follows that after a finite number of transformations a graph $G_k$ with $G_k \models c$ has to exist. 
Since no consistency increasing transformation $G_k \Longrightarrow G_{k+1}$ exists, the sequence has to be finite.
Also, for some $G_{k'}$ there may not exist a consistency increasing transformation $G_{k'} \Longrightarrow_{\rho} H$ with $\rho \in \mathcal{R}$ and therefore the sequence is also finite, but does not end with a consistent graph.  
\end{proof}

A transformation $t$ is considered as consistency increasing if the number of introduced violations is smaller than the number of deleted 


\begin{definition}[\textbf{direct minimal consistency improving}]\label{def_direct_improving}
Let $G$ be a graph, $\rho$ a plain rule and $c$ a constraint in EANF.
Let $d = \forall(a_k: C_{k-1} \inj C_{k}, e)$ be the condition at layer $k = \maxc{G} + 1 \leq \nl(c)$ of $c$.
A transformation $t: G \Longrightarrow_{\rho,m} H$ is called \emph{direct minimal consistency improving} if the following equations hold. 

Every occurrence of $C_k$ in $G$ that satisfies $\parcond(1,e,C')$ for any $C' \in \mathcal{U}(C_k, C_{k+1})$ still satisfies $\parcond(1,e,C')$ in $H$. 
\begin{equation}\label{direct_improving_1}
\begin{split}
	\forall p: C_{k} \inj G\Big( \bigwedge_{C' \in \mathcal{U}(C_k, C_{k+1})}\big(& p \models \parcond(1,e,C') \wedge \track_t \circ p \text{ is total}\big) \\ &\implies  \track_t \circ p \models \parcond(1,e,C') \Big) 
\end{split}
\end{equation}
Every new inserted occurrence of $C_k$ by $t$ satisfies $\parcond(1,e,C_{k+1})$.
\begin{equation}\label{direct_improving_1_2}
\begin{split}
\forall p': C_{k} \inj H \big(\neg \exists p : C_k \inj G(p' = \track_t \circ p) \implies \ p' \models \parcond(1,e,C_{k+1})\big)
\end{split}
\end{equation}
At least one occurrence of $C_k$ in $G$ that does not satisfy $\parcond(1,e,C')$, for any $C' \in \mathcal{U}(C_k, C_{k+1})$, either has been destroyed by $t$ or satisfies $\parcond(1,e,C')$ in $H$.
\begin{equation}\label{direct_improving_2}
\begin{split}
\exists p: C_k \inj G \Big(\bigvee_{C' \in \mathcal{U}(C_k, C_{k+1})}\big( &p \not \models \parcond(1,e,C') \wedge (\track_t \circ p \text{ is not total } \\&\vee(\track_t \circ p \text{ is total } \wedge \track_t \circ p  \models \parcond(1,e,C')))\big) \Big) 
\end{split}
\end{equation}

No occurrence of a universally bound graph $C_j$ with $j < k$ gets inserted. 
\begin{equation}\label{direct_improving_3}
\bigwedge_{\substack{i < k \\ i \textit{ even}}} \forall p: C_i \inj H ( \exists p': C_i \inj G (p' = \track_t \circ p))
\end{equation}
No occurrence of an existentially bound graph $C_j$ with $j < k$ gets deleted. 
\begin{equation}\label{direct_improving_4}
\bigwedge_{\substack{i < k \\ i \textit{ odd}}} \forall p: C_i \inj G( \track_t \circ p \textit{ is total})
\end{equation}

\end{definition}

\begin{lemma}\label{lemma_consistent}
	Let a transformation $t: G \Longrightarrow H$ and a constraint $c$ in EANF be given, such that (\ref{direct_improving_3}) and (\ref{direct_improving_4}) of definition \ref{def_direct_improving} are satisfied. Then,
	$$H \models_{\maxc{G}} c.$$
\end{lemma}
\begin{proof}
Assume that $G \not \models_{\maxc{G}}c$. 
Then, either a new occurrence of an universally bound graph of $c$ has been inserted or an occurrence of an existentially bound graph of $c$ has been destroyed. 
Therefore, the following holds:
$$ \exists p: C_i \inj G(\neg \exists p': C_i \inj (p' = \track_t \circ p) \vee \exists p:C_j \inj G(\track_t \circ p \textit{ is not total})$$
with $i, j < k$, $i$ being odd and $j$ being even. 
It follows immediately that either (\ref{direct_improving_3}) or (\ref{direct_improving_4}) is not satisfied. 
This is a contradiction. 
\end{proof}


\begin{lemma}
Let a graph $G$, a constraint $c$ in EANF and a direct minimal improving transformation $t: G \Rightarrow_{r,m} H$ w.r.t. $c$ be given. 
Then, $t$ is also a minimal improving transformation. 
\end{lemma}

\begin{proof}

Let $G$ be a graph with $k = \maxc{G}+1$ and $G \models \parcond(k,c,C)$ with $\parcond(k,c,C)\in \mathcal{P}_c^G$
Let $d$ be the subcondition of $c$ at layer $k$.
With lemma \ref{lemma_consistent} follows that $\maxc{H} \geq \maxc{G}$ and with that $\nvc(k,H) \neq \infty$.

\begin{enumerate}
\item \label{proof_direct_minimal_4} We show that equations (\ref{direct_improving_1}) and (\ref{direct_improving_1_2}) imply that $\nvc(k,H) \leq \nvc(k,G)$. 
Assume that $\nvc(k,H) > \nvc(k,G)$. Therefore, a morphism $p: C_k \inj H$ with $p \not \models \parcond(1,d,C')$ for any $C' \in \mathcal{U}(C,C_{k+1})$ exists, such that either \ref{proof_direct_minimal_1} or \ref{proof_direct_minimal_2} is satisfied.
\begin{enumerate}
	\item \label{proof_direct_minimal_1}
		There does exist a morphism $q': C_k \inj G$ with $q' \models \parcond(1,d,C')$ and $p = \track_t \circ q'$. 

	\item \label{proof_direct_minimal_2}
		There does not exist a morphism $q : C_k \inj G$, such that $p = \track_t \circ q$. 		
\end{enumerate}
This is a contradiction, if \ref{proof_direct_minimal_1} is satisfied, $q'$ does not satisfy equation (\ref{direct_improving_1}) and if \ref{proof_direct_minimal_2} is satisfied $q$ does not satisfy equation (\ref{direct_improving_1_2}).
It also follows that 
$$|\{q \mid q:C_k \inj G \wedge q \not \models \parcond(1,e,C')\}| \leq |\{q \mid q:C_{k} \inj H \wedge q \not \models \parcond(1,e,C')\}|$$
for all $C' \in \mathcal{U}(C_k, C_{k+1})$.

\item \label{proof_direct_minimal_3} Since (\ref{direct_improving_2}) is satisfied,  a morphism $p:C_k \inj G$ with $p \not \models \parcond(1,d,C')$, such that either $\track \circ p$ is total and $\track_t \circ p  \models \parcond(1,d,C')$ or $\track \circ p$ is not total exists, for any $C' \in \mathcal{U}(C_k, C_{k+1})$.
In both cases the following holds 
\begin{equation*}
\begin{split}
	p &\in \{q \mid q:C_k \inj G \wedge q \not \models \parcond(1,e,C')\} \wedge \\
	\track \circ p &\notin \{q \mid q:C_{k} \inj H \wedge q \not \models \parcond(1,e,C')\}.
\end{split}
\end{equation*}
With that and \ref{proof_direct_minimal_4}. it follows that
$$|\{q \mid q:C_k \inj G \wedge q \not \models \parcond(1,e,C')\}| < |\{q \mid q:C_{k} \inj H \wedge q \not \models \parcond(1,e,C')\}|.$$


\end{enumerate}
In total  $\nvc(k,H) < \nvc(k,G)$ follows and  $t$ is a minimal improving transformation. 
\end{proof}

\subsection{Comparison with other consistency concepts}

\begin{lemma}\label{comp_guaranteeing_minimal}
Let a constraint $c$ in ANF, graphs $G$ and $H$ with $G \not \models c$, and a transformation $t: G \Longrightarrow H$ be given. Then, 
$$t \text{ is c-guaranteeing } \implies t \text{ is minimal consistency improving w.r.t c}$$,
$$t \text{ is c-guaranteeing } \centernot \implies t \text{ is direct minimal consistency improving w.r.t c}$$
and 
$$t \text{ is minimal consistency improving w.r.t c} \centernot\implies t \text{ is c-guaranteeing }$$
\end{lemma}


\begin{proof}
Let $c'$ be the equivalent constraint in EANF. 
\begin{enumerate}
 \item Let $t$ be c-guaranteeing transformation, then $H \models c$. 
Since $G \not \models c$, $G \not \models c'$  follows and $\nvc(\maxc{G} + 1, G) > 0$ and $\nvc(\maxc{G} + 1, H) = 0$. Therefore $t$ is minimal consistency improving. 

\item Let a constraint $c = \exists(a_0: \emptyset \inj C_0, \forall(a_1: C_0 \inj C_1, \exists(a_2:C_1 \inj C_2, \true)))$ and a graph $G = C' \dot{\cup} C'$ with $C' = C_2 \setminus \{e\}$ for an $e \in E_{C_2\setminus C_1}$ and the occurrences $p_1: C_1 \inj G$ and $p_2: C_1 \inj G$  be given. 
Let $t: G \Longrightarrow H$ be a transformation with $H = C_2 \dot{\cup} C''$ and $C'' = C' \setminus\{e'\}$ for an $e' \in E_{C_2 \setminus C_1}$, such that $\track_t \circ p_1$ and $\track_t \circ p_2$ are total. 
Then, $t$ is $c$-guaranteeing and not direct minimal consistency improving, since $p_i \models \exists(a'_2:C_1 \inj C', \true)$  for $i = 1,2$ and either $\track_t \circ p_1 \not \models \exists(a'_2:C_1 \inj C', \true)$ or $\track_t \circ p_2 \not \models \exists(a'_2:C_1 \inj C', \true)$.

\item Let $t$ be a minimal consistency improving transformation w.r.t $c'$, such that $\nvc(\maxc{G} + 1, H)> \nvc(\maxc{G} + 1, H) > 1$ and $H \not \models_{\maxc{G} + 2} c'$.
Then,$H \not \models c'$ and $t$ is not a guaranteeing transformation. 
\end{enumerate}

\end{proof}

\begin{corollary}
Let $c$ be an existentially bound constraint in ANF. 
Then, a transformation $t$ is $c$-guaranteeing if and only if it is consistency improving. 
With lemma \ref{comp_guaranteeing_minimal} follows:
$$t \text{ is consistency guaranteeing w.r.t c } \implies t \text{ is minimal consistency improving w.r.t c}$$
and 
$$t \text{ is minimal consistency improving w.r.t c} \centernot\implies t \text{ is consistency improving w.r.t c }$$
\end{corollary}

\begin{lemma}
	let a universally bound constraint $c$ with $\nl(c) = 1$ in ANF, graphs $G$ and $H$ with $G \not \models c$, and a transformation $t: G \Longrightarrow H$ be given. 
	Then,
	$$t \text{ is consistency improving } \iff \text{ is minimal consistency improving}$$ 
	
\end{lemma}

\begin{proof}
Let $c = \forall(a: \emptyset \inj C, \false)$. Then, the equivalent constraint in EANF is $c' = \forall(a:\emptyset \inj C, \exists(\id: C \inj C, \false)$. 
Since $\mathcal{U}(C,C) = \{C\}$, $\nvc(1,G)$ is the number of occurrences of $C$ in $G$. 
This is exactly the definition of the number of violations for consistency improving transformations and 
$$t \text{ is minimal consistency improving } \iff t \text{ is consistency improving}$$
follows immediately.
\end{proof}

\begin{lemma}
Let a universally bound constraint $c$ with $\nl(c) \geq 2$ in ANF, graphs $G$ and $H$ with $G\not \models c$ and a transformation $t: G \Longrightarrow H$ be given. Then,

$$t \text{ is direct consistency improving } \centernot \implies t \text{ is minimal consistency improving}$$ 
and 
$$t \text{ is direct minimal consistency improving } \centernot \implies t \text{ is consistency sustaining}$$ 
\end{lemma}

\begin{proof}
\begin{enumerate}
\item Let $c = \forall(a_0: \emptyset \inj C_0, \exists(a_1: C_0 \inj C_1, \true))$ be a constraint.
Let $V_{C_0} = V_{C_1}$ and $|E_{C_1}| - |E_{C_0}| = 2$. Let $G = C' \dot \cup C'$ with $C' = C_1 \setminus \{e\}$ with $e \in E_{C_1}\setminus E_{C_0} $ and the occurrences $p_1: C_0 \inj G$ and $p_2: C_0 \inj G$ be given. It follows that $\nvc(1,G) = 2$.
Let $t: G \Longrightarrow H$ be a transformation, such that $H = C_0$. 
Then, $t$ is a direct consistency improving transformation, since $H$ contains only one occurrence of $C_0$ not satisfying $\exists(a_1:C_0 \inj C_1 \true)$. But, $t$ is not minimal consistency improving since $\nvc(1,H) = 3$.

\item Let $c := \forall(a_0: \emptyset \inj C_0, \exists(a_1: C_0 \inj C_1, \forall(a_2: C_1 \inj C_2, \exists(a_3: C_2 \inj C_3, \true))))$ be a constraint.

Let a graph $G = C_0$ with the morphism $q: C_0 \inj G$ and a transformation $t: G \Longrightarrow H$ with $H := C_2 \dot{\cup} C_2$ be given, such that $\track_t \circ q$ is total. 
	Then $t$ is a direct minimal consistency improving transformation but not a consistency sustaining one, since $H$ contains more occurrences of $C_0$ not satisfying $\exists(a_1: C_0 \inj C_1, \forall(a_2: C_1 \inj C_2, \exists(a_3: C_2 \inj C_3, \true)))$ than $G$. 
\end{enumerate}
\end{proof}

\begin{lemma}
Let a universally bound constraint $c$ with $\nl(c) \geq 2$ in ANF, graphs $G$ and $H$ with $G \not \models c$ and a transformation $t: G \Longrightarrow H$ be given. 
If $t$ satisfies $(\ref{direct_improving_1})$ and $(\ref{direct_improving_1_2})$, $H \models_{\maxc{G}} c$ and 
$$\exists p:C_0 \inj G(p \not \models \parcond(\maxc{G} + 2, c, \true) \wedge \track_t \circ p \models c).$$
Then,  
$$t \text{ is consistency improving} \implies t \text{ is minimal consistency improving}.$$ 

\end{lemma}
\begin{proof}

\end{proof}


