\subsection{Rule-based Graph Repair for multiple Constraints}

Now, we will introduce our rule-based repair approach for a set of constraints in UANF. 


\begin{definition}[\textbf{satisfaction of constraint sets}]
	Let a set of constraints $\mathcal{C}$ be given. 
	A graph $G$ satisfies $\mathcal{C}$, denoted by $G \models \mathcal{C}$,
	if $G \models \bigwedge_{c \in \mathcal{C}} c$.
	The set $\mathcal{C}$ is called \emph{satisfiable } if a graph $G$ with 
	$G \models \mathcal{C}$ exists.
\end{definition}

To guarantee that a set of constraints can be repaired by a set of rules, we 
need to extend the notion of repairing sets such that a a set of rules 
is called a \emph{repairing set} for a set of constraints if it is a repairing 
set for each constraint in the constraint set. 
\begin{definition}[\textbf{repairing set for a set of constraints}]
	Let a set of constraints $\mathcal{C}$ and a set of rules $\mathcal{R}$ be 
	given. 
	Then, $\mathcal{R}$ is called a \emph{repairing set for $\mathcal{C}$} if 
	$\mathcal{R}$ is a repairing set for all constraints $c \in \mathcal{C}$.

\end{definition}

We also extend the notion of conflicts to \emph{conflicts between 
constraints}. 
Intuitively, a constraint $c$ has a conflict with another constraint $c'$ if one of its graphs has a conflict with a graph of $c'$.

\begin{definition}[\textbf{conflict between constraints}]
	Let constraints $c$, $c'$ in UANF and a set of rules $\mathcal{R}$ be given. 
	Then, $c$ has a conflict with $c'$ if a repairing sequence 
	$$C_k = G_0 \Longrightarrow_{\rho_1,m_1} \ldots \Longrightarrow_{\rho_n,m_n}
	G_n$$
	for a graph $C_k$ of $c$ exists such that the concurrent rule of this 
	sequence is not basic consistency maintaining rule w.r.t. $\forall(C_j, 
	\false)$ or $\exists(C_j,\true)$ for any universally or existentially 
	bound graph $C_j$ of $c'$.  

\end{definition}

The following Lemma is a useful statement for the correctness proof of our 
repair approach. 
It states that the application of a repairing sequence of a constraint $c$ cannot 
destroy the satisfaction of $c'$ if $c$ has no conflict with $c'$.

\begin{lemma}\label{lemma_preserving}
	Let two constraints $c$ and $c'$ in UANF, such that $c$ has no conflict with 
	$c'$ w.r.t. to a set of rules $\rho$, be given.
	Then the concurrent rule $\rho$ of each repairing sequence for $c$ is a 
	$c'$-preserving rule.  
\end{lemma}
\begin{proof}
	Assume that $\rho$ is not a $c'$-preserving rule. 
	Then, there does exist a transformation $t : G \Longrightarrow_{rho,m} H$ 
	such that $G \models c'$ and $H \not \models C'$. 
	Therefore, either an universally bound graph of $c'$ has been inserted 
	or an existentially bound graph of $c'$ has been removed. 
	Since $\rho$ is a basic maintaining rule w.r.t. $\forall(C_j, \false)$ for 
	all universally bound graphs $C_j$ of $c'$ and a basic consistency 
	maintaining rule w.r.t. $\exists(C_j, \true)$ for all existentially bound 
	graphs $C_j$ of $c'$, this is a contradiction.
\end{proof}

\input{Algorithms/algo_non-conflict_free}

The \emph{conflicts graph} for a set of constraints and \emph{circular conflicts}
for it are defined in a similar manner as conflict graphs and circular conflicts for one constraint. 
A set of constraints is called \emph{circular conflict free} if each of its constraints is circular conflict free and there does not exist a sequence 
$c = c_0, \ldots c_n = c$ such that $c_i$ has a conflict with $c_{i+1}$ for all 
$0\leq i < n$. In other words, the conflict graph of this set is acyclic.

\begin{definition}[\textbf{conflict graphs, circular conflicts}]
	Let a set of constraints $\mathcal{C}$ in UANF be given. The \emph{conflict 
	graph of $\mathcal{C}$} is constructed in the following way.
	For each constraint $c \in \mathcal{C}$ there does exist a node.
	If a conflict between $c$ and $c'$ exists, there does exist an edge 
	$e$ with $\src(e) = c$ and $\tar(e) = c'$.
	
	A constraint $c$ has a \emph{transitive conflict} with $c'$ if the 
	conflict graph of $\mathcal{C}$ contains a path from $c$ to $c'$. 
	A constraint $c$ has a \emph{circular conflict} if $c$ has a transitive 
	conflict with itself. 
	A set of constraints $\mathcal{C}$ is called \emph{circular conflict free} if 
	each constraint in $\mathcal{C}$ is circular conflict free and 
	does not contain any circular conflicts.

\end{definition}

\begin{example}
	Consider the rules \emph{\texttt{resolve, resolve2, createFeatures}} and 
	constraints $c_1$ and $c_5$ given in Figures \ref{fig:constraint_conflict}
	and \ref{fig:constraints}.
	The constraint set $\mathcal{C} = \{c_1, c_5\}$ is a multiplicity 
	stating that \enquote{Each node of type \emph{\texttt{Class}} is connected 
	to exactly two nodes of type \emph{\texttt{Feature}}}.
	With the rule set $\mathcal{R}_1 = \{\emph{\texttt{resolve}}, 
	\emph{\texttt{createFeatures}}\}$, there is only one conflict in 
	$\mathcal{C}$;  $c_1$ has a conflict with $c_5$ since 
	an application of \emph{\texttt{createFeatures}} could lead 
	to an insertion of the universally bound graph of $c_5$.
	With the rule set $\mathcal{R}_2 =
	\{\emph{\texttt{resolve2}}, \emph{\texttt{createFeatures}}\}$ there are two 
	conflicts. Again, there is a conflict of $c_1$ with $c_5$, but also a 
	conflict of $c_5$ with $c_1$ since an application of \emph{\texttt{resolve}}
	can destroy an occurrence of the existentially bound graph of $c_1$.
	
	Therefore, our approach can repair with the rule set $\mathcal{R}_1$ 
	but not with  $\mathcal{R}_2$ because in this case, $\mathcal{C}$ is 
	not circular conflict free.
	
\end{example}
\input{figures/fig_example_constraint_conflict}

Our repair process makes use of the fact that the conflict graph of a 
circular conflict free set of constraints in UANF is acyclic. 
In particular, our approach uses the \emph{topological ordering} of this 
conflict graph.

\begin{definition}[\textbf{topological ordering of a graph}]
	Let a graph $G$ be given. 
	A sequence $(v_1, \ldots, v_n)$ of nodes of $G$ is called 
	a \emph{topological ordering} of $G$ no edge $e \in E_G$ with 
	$\src(e) = v_i$, $\tar(e) = v_j$ and $i \geq j$ exists. 
	The topological ordering of a circular conflict free set of constraints 
	$\mathcal{C}$ is the topological ordering of its conflicts graph.
\end{definition}
It is a well known fact that each directed acyclic graph has a topological 
ordering and therefore each conflict graph of a circular conflict free set
of constraints also has a topological ordering.

The repair process is given in Algorithm \ref{Algo_non-conflict_free} and 
proceeds in the following way. 
First, the topological ordering of the constraint set is determined (line 1) 
Then, Algorithm \ref{Algo_conflict_free} is used to repair each constraint of 
$\mathcal{C}$ in order of the topological ordering (line 2 --4). 
Through this, it is ensured that the satisfaction of a constraint that has 
already been repaired will not be destroyed by the repair of another constraint. 
\begin{theorem}
	Let a graph $G$, a satisfiable, circular conflict free set of constraints in 
	UANF, 
	$\mathcal{C}$, and a set of rules $\mathcal{R}$ be given.
	Then, Algorithm  \ref{Algo_non-conflict_free} terminates and returns a 
	graph $H$ with $H \models \mathcal{C}$.
\end{theorem}
\begin{proof}
	Since $\mathcal{C}$ is finite and each $c \in \mathcal{C}$ is 
	circular conflict free,  Algorithm \ref{Algo_conflict_free} 
	terminates for each $c \in \mathcal{C}$. Therefore, Algorithm 
	\ref{Algo_non-conflict_free} will also terminate. 
	
	It remains to show that the returned graph satisfies $\mathcal{C}$.
	Let $(c_1, \ldots, c_n)$ be a topological ordering of $\mathcal{C}$.
	Then no constraint $c_j$ with $j \neq 1$ has a conflict with 
	$c_1$ and with Lemma \ref{lemma_preserving} follows that the 
	concurrent rule of each repairing sequence for each $c_i$ with $2 \leq 
	i \leq n$ is a $c_1$-preserving rule. 
	In general, the concurrent rule of each repairing sequence for $c_j$ is a
	$c_i$-preserving rule if $i < j$.
	Note that in Algorithm \ref{Algo_non-conflict_free} each repairing sequence 
	can be replaced by its concurrent rule. 
	After one iteration, $G \models c_1$.
	Assume that after $m$ iterations it holds that $G \models c_i$ for 
	all $1 \leq i \leq m$. 
	In iteration $m+1$, $c_{m+1}$ will be repaired by Algorithm 
	\ref{Algo_non-conflict_free}. Since each concurrent rule 
	of each repairing sequence of $c_{m+1}$ is a $c_i$-preserving rule 
	for all $1 \leq i \leq m$, the application of repairing sequence can 
	be replaced by its concurrent rule and Algorithm \ref{Algo_non-conflict_free} 
	only applies repairing sequences, it follows that $H \models c_i$ 
	for all $1 \leq i \leq m+1$.  
	Therefore, after $n$ iterations, $H \models c_i$ for all $1 \leq i \leq n$. 
	It follows immediately that the returned graph $G$ satisfies 
	$\mathcal{C}$.
\end{proof}